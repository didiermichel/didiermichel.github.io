<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <meta name="author" content="EnterpriseDB UK Limited" />
  <title>Barman Manual</title>
  <style type="text/css">code{white-space: pre;}</style>
  <style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; position: absolute; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; }
pre.numberSource a.sourceLine:empty
  { position: absolute; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: absolute; left: -5em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
  </style>
  <link rel="stylesheet" href="./html-templates/template.css" />
</head>
<body data-spy="scroll" data-target=".bs-docs-sidebar" >
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="nav-collapse collapse">
            <ul class="nav">
              <li>
                <a href="http://www.pgbarman.org/" title="visit Barman homepage">Barman</a>
              </li>
              <li>
                <a href="http://www.2ndQuadrant.com/" title="visit 2ndQuadrant homepage">2ndQuadrant</a>
              </li>
              <li>
                <a href="index.html">manual</a>
              </li>
              <li>
                <a href="barman.1.html" title="Section 1 of the man page for Barman">man1</a>
              </li>
              <li>
                <a href="barman.5.html" title="Section 5 of the man page for Barman">man5</a>
              </li>
              </ul>
              <ul class="nav">
              <li>
                <a href="barman-cloud-backup.1.html" title="Section 1 of the man page for barman-cloud-backup command">cloud backup</a>
              </li>
              <li>
                <a href="barman-cloud-backup-list.1.html" title="Section 1 of the man page for barman-cloud-backup-list command">cloud backup list</a>
              </li>
              <li>
                <a href="barman-cloud-backup-delete.1.html" title="Section 1 of the man page for barman-cloud-backup-delete command">cloud backup delete</a>
              </li>
              <li>
                <a href="barman-cloud-backup-keep.1.html" title="Section 1 of the man page for barman-cloud-backup-keep command">cloud backup keep</a>
              </li>
              <li>
                <a href="barman-cloud-restore.1.html" title="Section 1 of the man page for barman-cloud-restore command">cloud restore</a>
              </li>
              <li>
                <a href="barman-cloud-wal-archive.1.html" title="Section 1 of the man page for barman-cloud-wal-archive command">cloud wal archive</a>
              </li>
              <li>
                <a href="barman-cloud-check-wal-archive.1.html" title="Section 1 of the man page for barman-cloud-check-wal-archive command">cloud check wal archive</a>
              </li>
              <li>
                <a href="barman-cloud-wal-restore.1.html" title="Section 1 of the man page for barman-cloud-wal-restore command">cloud wal restore</a>
              </li>
              <li>
                <a href="barman-wal-archive.1.html" title="Section 1 of the man page for barman-wal-archive command">wal archive</a>
              </li>
              <li>
                <a href="barman-wal-restore.1.html" title="Section 1 of the man page for barman-wal-restore command">wal restore</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

  <div class="navbar navbar-static-top">
    <div class="navbar-inner">
      <div class="container">
        <span class="doc-title">Barman Manual</span>
        <ul class="nav pull-right doc-info">
                    <li><p class="navbar-text">EnterpriseDB UK Limited</p></li>
                              <li><p class="navbar-text">December 14, 2022 (3.3.0)</p></li>
                  </ul>
      </div>
    </div>
  </div>
    <div class="container">
    <div class="row">
            <div id="TOC" class="span3">
        <div class="well toc">
        <ul id="toc" class="nav">
          <li class="nav-header">Table of Contents</li>
        </ul>
        <ul>
        <li><a href="#introduction">Introduction</a></li>
        <li><a href="#before-you-start">Before you start</a></li>
        <li><a href="#design-and-architecture">Design and architecture</a><ul>
        <li><a href="#where-to-install-barman">Where to install Barman</a></li>
        <li><a href="#one-barman-many-postgresql-servers">One Barman, many PostgreSQL servers</a></li>
        <li><a href="#streaming-backup-vs-rsyncssh">Streaming backup vs rsync/SSH</a></li>
        <li><a href="#the-barman-wal-archive">The Barman WAL archive</a></li>
        <li><a href="#two-typical-scenarios-for-backups">Two typical scenarios for backups</a></li>
        </ul></li>
        <li><a href="#system-requirements">System requirements</a><ul>
        <li><a href="#requirements-for-backup">Requirements for backup</a></li>
        <li><a href="#requirements-for-recovery">Requirements for recovery</a></li>
        </ul></li>
        <li><a href="#installation">Installation</a><ul>
        <li><a href="#installation-on-redhatcentos-using-rpm-packages">Installation on RedHat/CentOS using RPM packages</a></li>
        <li><a href="#installation-on-debianubuntu-using-packages">Installation on Debian/Ubuntu using packages</a></li>
        <li><a href="#installation-on-sles-using-packages">Installation on SLES using packages</a></li>
        <li><a href="#installation-from-sources">Installation from sources</a></li>
        <li><a href="#postgresql-clientserver-binaries">PostgreSQL client/server binaries</a></li>
        </ul></li>
        <li><a href="#upgrading-barman">Upgrading Barman</a><ul>
        <li><a href="#upgrading-to-barman-3.0.0">Upgrading to Barman 3.0.0</a></li>
        <li><a href="#upgrading-from-barman-2.10">Upgrading from Barman 2.10</a></li>
        <li><a href="#upgrading-from-barman-2.x-prior-to-2.8">Upgrading from Barman 2.X (prior to 2.8)</a></li>
        <li><a href="#upgrading-from-barman-1.x">Upgrading from Barman 1.X</a></li>
        </ul></li>
        <li><a href="#configuration">Configuration</a><ul>
        <li><a href="#options-scope">Options scope</a></li>
        <li><a href="#examples-of-configuration">Examples of configuration</a></li>
        </ul></li>
        <li><a href="#setup-of-a-new-server-in-barman">Setup of a new server in Barman</a><ul>
        <li><a href="#preliminary-steps">Preliminary steps</a></li>
        <li><a href="#the-server-configuration-file">The server configuration file</a></li>
        <li><a href="#wal-streaming">WAL streaming</a></li>
        <li><a href="#wal-archiving-via-archive_command">WAL archiving via <code>archive_command</code></a></li>
        <li><a href="#verification-of-wal-archiving-configuration">Verification of WAL archiving configuration</a></li>
        <li><a href="#streaming-backup">Streaming backup</a></li>
        <li><a href="#backup-with-rsyncssh">Backup with <code>rsync</code>/SSH</a></li>
        <li><a href="#how-to-setup-a-windows-based-server">How to setup a Windows based server</a></li>
        </ul></li>
        <li><a href="#general-commands">General commands</a><ul>
        <li><a href="#cron"><code>cron</code></a></li>
        <li><a href="#diagnose"><code>diagnose</code></a></li>
        <li><a href="#list-servers"><code>list-servers</code></a></li>
        </ul></li>
        <li><a href="#server-commands">Server commands</a><ul>
        <li><a href="#archive-wal"><code>archive-wal</code></a></li>
        <li><a href="#backup"><code>backup</code></a></li>
        <li><a href="#check"><code>check</code></a></li>
        <li><a href="#generate-manifest"><code>generate-manifest</code></a></li>
        <li><a href="#get-wal"><code>get-wal</code></a></li>
        <li><a href="#list-backups"><code>list-backups</code></a></li>
        <li><a href="#rebuild-xlogdb"><code>rebuild-xlogdb</code></a></li>
        <li><a href="#receive-wal"><code>receive-wal</code></a></li>
        <li><a href="#replication-status"><code>replication-status</code></a></li>
        <li><a href="#show-servers"><code>show-servers</code></a></li>
        <li><a href="#status"><code>status</code></a></li>
        <li><a href="#switch-wal"><code>switch-wal</code></a></li>
        <li><a href="#verify"><code>verify</code></a></li>
        </ul></li>
        <li><a href="#backup-commands">Backup commands</a><ul>
        <li><a href="#backup-id-shortcuts">Backup ID shortcuts</a></li>
        <li><a href="#check-backup"><code>check-backup</code></a></li>
        <li><a href="#delete"><code>delete</code></a></li>
        <li><a href="#keep"><code>keep</code></a></li>
        <li><a href="#list-files"><code>list-files</code></a></li>
        <li><a href="#recover"><code>recover</code></a></li>
        <li><a href="#show-backup"><code>show-backup</code></a></li>
        </ul></li>
        <li><a href="#features-in-detail">Features in detail</a><ul>
        <li><a href="#backup-features">Backup features</a></li>
        <li><a href="#archiving-features">Archiving features</a></li>
        <li><a href="#catalog-management-features">Catalog management features</a></li>
        <li><a href="#hook-scripts">Hook scripts</a></li>
        <li><a href="#customization">Customization</a></li>
        <li><a href="#integration-with-cluster-management-systems">Integration with cluster management systems</a></li>
        <li><a href="#parallel-jobs">Parallel jobs</a></li>
        <li><a href="#geographical-redundancy">Geographical redundancy</a></li>
        </ul></li>
        <li><a href="#barman-client-utilities-barman-cli">Barman client utilities (<code>barman-cli</code>)</a><ul>
        <li><a href="#installation-1">Installation</a></li>
        </ul></li>
        <li><a href="#barman-client-utilities-for-the-cloud-barman-cli-cloud">Barman client utilities for the Cloud (<code>barman-cli-cloud</code>)</a><ul>
        <li><a href="#installation-2">Installation</a></li>
        <li><a href="#barman-cloud-hook-scripts">barman-cloud hook scripts</a></li>
        <li><a href="#selecting-a-cloud-provider">Selecting a cloud provider</a></li>
        <li><a href="#specificity-by-provider">Specificity by provider</a></li>
        </ul></li>
        <li><a href="#troubleshooting">Troubleshooting</a><ul>
        <li><a href="#diagnose-a-barman-installation">Diagnose a Barman installation</a></li>
        <li><a href="#requesting-help">Requesting help</a></li>
        </ul></li>
        <li><a href="#the-barman-project">The Barman project</a><ul>
        <li><a href="#support-and-sponsor-opportunities">Support and sponsor opportunities</a></li>
        <li><a href="#contributing-to-barman">Contributing to Barman</a></li>
        <li><a href="#authors">Authors</a></li>
        <li><a href="#links">Links</a></li>
        <li><a href="#license-and-contributions">License and Contributions</a></li>
        </ul></li>
        </ul>
        </div>
      </div>
            <div id="CONTENT" class="span9">
            <p><strong>Barman</strong> (Backup and Recovery Manager) is an open-source administration tool for disaster recovery of PostgreSQL servers written in Python. It allows your organisation to perform remote backups of multiple servers in business critical environments to reduce risk and help DBAs during the recovery phase.</p>
<p><a href="https://www.pgbarman.org/">Barman</a> is distributed under GNU GPL 3 and maintained by <a href="https://www.enterprisedb.com/">EnterpriseDB</a>, a platinum sponsor of the <a href="https://www.postgresql.org/">PostgreSQL project</a>.</p>
<blockquote>
<p><strong>IMPORTANT:</strong>  This manual assumes that you are familiar with theoretical disaster recovery concepts, and that you have a grasp of PostgreSQL fundamentals in terms of physical backup and disaster recovery. See section <em>&quot;Before you start&quot;</em> below for details.</p>
</blockquote>

<h1 id="introduction">Introduction</h1>
<p>In a perfect world, there would be no need for a backup. However, it is important, especially in business environments, to be prepared for when the <em>&quot;unexpected&quot;</em> happens. In a database scenario, the unexpected could take any of the following forms:</p>
<ul>
<li>data corruption</li>
<li>system failure (including hardware failure)</li>
<li>human error</li>
<li>natural disaster</li>
</ul>
<p>In such cases, any ICT manager or DBA should be able to fix the incident and recover the database in the shortest time possible. We normally refer to this discipline as <strong>disaster recovery</strong>, and more broadly <em>business continuity</em>.</p>
<p>Within business continuity, it is important to familiarise with two fundamental metrics, as defined by Wikipedia:</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Recovery_point_objective"><strong>Recovery Point Objective (RPO)</strong></a>: <em>&quot;maximum targeted period in which data might be lost from an IT service due to a major incident&quot;</em></li>
<li><a href="https://en.wikipedia.org/wiki/Recovery_time_objective"><strong>Recovery Time Objective (RTO)</strong></a>: <em>&quot;the targeted duration of time and a service level within which a business process must be restored after a disaster (or disruption) in order to avoid unacceptable consequences associated with a break in business continuity&quot;</em></li>
</ul>
<p>In a few words, RPO represents the maximum amount of data you can afford to lose, while RTO represents the maximum down-time you can afford for your service.</p>
<p>Understandably, we all want <strong>RPO=0</strong> (<em>&quot;zero data loss&quot;</em>) and <strong>RTO=0</strong> (<em>zero down-time</em>, utopia) - even if it is our grandmothers's recipe website. In reality, a careful cost analysis phase allows you to determine your business continuity requirements.</p>
<p>Fortunately, with an open source stack composed of <strong>Barman</strong> and <strong>PostgreSQL</strong>, you can achieve RPO=0 thanks to synchronous streaming replication. RTO is more the focus of a <em>High Availability</em> solution, like <a href="https://www.repmgr.org/"><strong>repmgr</strong></a>. Therefore, by integrating Barman and repmgr, you can dramatically reduce RTO to nearly zero.</p>
<p>Based on our experience at EnterpriseDB, we can confirm that PostgreSQL open source clusters with Barman and repmgr can easily achieve more than 99.99% uptime over a year, if properly configured and monitored.</p>
<p>In any case, it is important for us to emphasise more on cultural aspects related to disaster recovery, rather than the actual tools. Tools without human beings are useless.</p>
<p>Our mission with Barman is to promote a culture of disaster recovery that:</p>
<ul>
<li>focuses on backup procedures</li>
<li>focuses even more on recovery procedures</li>
<li>relies on education and training on strong theoretical and practical concepts of PostgreSQL's crash recovery, backup, Point-In-Time-Recovery, and replication for your team members</li>
<li>promotes testing your backups (only a backup that is tested can be considered to be valid), either manually or automatically (be creative with Barman's hook scripts!)</li>
<li>fosters regular practice of recovery procedures, by all members of your devops team (yes, developers too, not just system administrators and DBAs)</li>
<li>solicits to regularly scheduled drills and disaster recovery simulations with the team every 3-6 months</li>
<li>relies on continuous monitoring of PostgreSQL and Barman, and that is able to promptly identify any anomalies</li>
</ul>
<p>Moreover, do everything you can to prepare yourself and your team for when the disaster happens (yes, <em>when</em>), because when it happens:</p>
<ul>
<li>It is going to be a Friday evening, most likely right when you are about to leave the office.</li>
<li>It is going to be when you are on holiday (right in the middle of your cruise around the world) and somebody else has to deal with it.</li>
<li>It is certainly going to be stressful.</li>
<li>You will regret not being sure that the last available backup is valid.</li>
<li>Unless you know how long it approximately takes to recover, every second will seems like forever.</li>
</ul>
<p>Be prepared, don't be scared.</p>
<p>In 2011, with these goals in mind, 2ndQuadrant started the development of Barman, now one of the most used backup tools for PostgreSQL. Barman is an acronym for &quot;Backup and Recovery Manager&quot;.</p>
<p>Currently, Barman works only on Linux and Unix operating systems.</p>

<h1 id="before-you-start">Before you start</h1>
<p>Before you start using Barman, it is fundamental that you get familiar with PostgreSQL and the concepts around physical backups, Point-In-Time-Recovery and replication, such as base backups, WAL archiving, etc.</p>
<p>Below you can find a non exhaustive list of resources that we recommend for you to read:</p>
<ul>
<li><em>PostgreSQL documentation</em>:
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/backup-dump.html">SQL Dump</a><a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a></li>
<li><a href="https://www.postgresql.org/docs/current/static/backup-file.html">File System Level Backup</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/continuous-archiving.html">Continuous Archiving and Point-in-Time Recovery (PITR)</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/wal.html">Reliability and the Write-Ahead Log</a></li>
</ul></li>
<li><em>Book</em>: <a href="https://www.2ndquadrant.com/en/books/postgresql-10-administration-cookbook/">PostgreSQL 10 Administration Cookbook</a></li>
</ul>
<p>Professional training on these topics is another effective way of learning these concepts. At any time of the year you can find many courses available all over the world, delivered by PostgreSQL companies such as EnterpriseDB.</p>

<h1 id="design-and-architecture">Design and architecture</h1>
<h2 id="where-to-install-barman">Where to install Barman</h2>
<p>One of the foundations of Barman is the ability to operate remotely from the database server, via the network.</p>
<p>Theoretically, you could have your Barman server located in a data centre in another part of the world, thousands of miles away from your PostgreSQL server. Realistically, you do not want your Barman server to be too far from your PostgreSQL server, so that both backup and recovery times are kept under control.</p>
<p>Even though there is no <em>&quot;one size fits all&quot;</em> way to setup Barman, there are a couple of recommendations that we suggest you abide by, in particular:</p>
<ul>
<li>Install Barman on a dedicated server</li>
<li>Do not share the same storage with your PostgreSQL server</li>
<li>Integrate Barman with your monitoring infrastructure <a href="#fn2" class="footnote-ref" id="fnref2"><sup>2</sup></a></li>
<li>Test everything before you deploy it to production</li>
</ul>
<p>A reasonable way to start modelling your disaster recovery architecture is to:</p>
<ul>
<li>design a couple of possible architectures in respect to PostgreSQL and Barman, such as:
<ol type="1">
<li>same data centre</li>
<li>different data centre in the same metropolitan area</li>
<li>different data centre</li>
</ol></li>
<li>elaborate the pros and the cons of each hypothesis</li>
<li>evaluate the single points of failure (SPOF) of your system, with cost-benefit analysis</li>
<li>make your decision and implement the initial solution</li>
</ul>
<p>Having said this, a very common setup for Barman is to be installed in the same data centre where your PostgreSQL servers are. In this case, the single point of failure is the data centre. Fortunately, the impact of such a SPOF can be alleviated thanks to two features that Barman provides to increase the number of backup tiers:</p>
<ol type="1">
<li><strong>geographical redundancy</strong> (introduced in Barman 2.6)</li>
<li><strong>hook scripts</strong></li>
</ol>
<p>With <em>geographical redundancy</em>, you can rely on a Barman instance that is located in a different data centre/availability zone to synchronise the entire content of the source Barman server. There's more: given that geo-redundancy can be configured in Barman not only at global level, but also at server level, you can create <em>hybrid installations</em> of Barman where some servers are directly connected to the local PostgreSQL servers, and others are backing up subsets of different Barman installations (<em>cross-site backup</em>). Figure  below shows two availability zones (one in Europe and one in the US), each with a primary PostgreSQL server that is backed up in a local Barman installation, and relayed on the other Barman server (defined as <em>passive</em>) for multi-tier backup via rsync/SSH. Further information on geo-redundancy is available in the specific section.</p>
<figure>
<img src="images/barman-architecture-georedundancy.png" alt="An example of architecture with geo-redundancy" style="width:80.0%" /><figcaption>An example of architecture with geo-redundancy</figcaption>
</figure>
<p>Thanks to <em>hook scripts</em> instead, backups of Barman can be exported on different media, such as <em>tape</em> via <code>tar</code>, or locations, like an <em>S3 bucket</em> in the Amazon cloud.</p>
<p>Remember that no decision is forever. You can start this way and adapt over time to the solution that suits you best. However, try and keep it simple to start with.</p>
<h2 id="one-barman-many-postgresql-servers">One Barman, many PostgreSQL servers</h2>
<p>Another relevant feature that was first introduced by Barman is support for multiple servers. Barman can store backup data coming from multiple PostgreSQL instances, even with different versions, in a centralised way. <a href="#fn3" class="footnote-ref" id="fnref3"><sup>3</sup></a></p>
<p>As a result, you can model complex disaster recovery architectures, forming a &quot;star schema&quot;, where PostgreSQL servers rotate around a central Barman server.</p>
<p>Every architecture makes sense in its own way. Choose the one that resonates with you, and most importantly, the one you trust, based on real experimentation and testing.</p>
<p>From this point forward, for the sake of simplicity, this guide will assume a basic architecture:</p>
<ul>
<li>one PostgreSQL instance (with host name <code>pg</code>)</li>
<li>one backup server with Barman (with host name <code>backup</code>)</li>
</ul>
<h2 id="streaming-backup-vs-rsyncssh">Streaming backup vs rsync/SSH</h2>
<p>Barman is able to take backups using either Rsync, which uses SSH as a transport mechanism, or <code>pg_basebackup</code>, which uses PostgreSQL's streaming replication protocol.</p>
<p>Choosing one of these two methods is a decision you will need to make, however for general usage we recommend using streaming replication for all currently supported versions of PostgreSQL.</p>
<blockquote>
<p><strong>IMPORTANT:</strong>  Because Barman transparently makes use of <code>pg_basebackup</code>, features such as incremental backup, parallel backup, and deduplication are currently not available. In this case, bandwidth limitation has some restrictions - compared to the traditional method via <code>rsync</code>.</p>
</blockquote>
<p>Backup using <code>rsync</code>/SSH is recommended in all cases where <code>pg_basebackup</code> limitations occur (for example, a very large database that can benefit from incremental backup and deduplication).</p>
<p>The reason why we recommend streaming backup is that, based on our experience, it is easier to setup than the traditional one. Also, streaming backup allows you to backup a PostgreSQL server on Windows<a href="#fn4" class="footnote-ref" id="fnref4"><sup>4</sup></a>, and makes life easier when working with Docker.</p>
<h2 id="the-barman-wal-archive">The Barman WAL archive</h2>
<p>Recovering a PostgreSQL backup relies on replaying transaction logs (also known as <em>xlog</em> or WAL files). It is therefore essential that WAL files are stored by Barman alongside the base backups so that they are available at recovery time. This can be achieved using either WAL streaming or standard WAL archiving to copy WALs into Barman's WAL archive.</p>
<p>WAL streaming involves streaming WAL files from the PostgreSQL server with <code>pg_receivewal</code> using replication slots. WAL streaming is able to reduce the risk of data loss, bringing RPO down to <em>near zero</em> values. It is also possible to add Barman as a synchronous WAL receiver in your PostgreSQL cluster and achieve <strong>zero data loss</strong> (RPO=0).</p>
<p>Barman also supports standard WAL file archiving which is achieved using PostgreSQL's <code>archive_command</code> (either via <code>rsync</code>/SSH, or via <code>barman-wal-archive</code> from the <code>barman-cli</code> package). With this method, WAL files are archived only when PostgreSQL <em>switches</em> to a new WAL file. To keep it simple this normally happens every 16MB worth of data changes.</p>
<p>It is <em>required</em> that one of WAL streaming or WAL archiving is configured. It is optionally possible to configure both WAL streaming <em>and</em> standard WAL archiving - in such cases Barman will automatically de-duplicate incoming WALs. This provides a fallback mechanism so that WALs are still copied to Barman's archive in the event that WAL streaming fails.</p>
<p>For general usage we recommend configuring WAL streaming only.</p>
<blockquote>
<p><strong>NOTE:</strong> Previous versions of Barman recommended that both WAL archiving <em>and</em> WAL streaming were used. This was because PostreSQL versions older than 9.4 did not support replication slots and therefore WAL streaming alone could not guarantee all WALs would be safely stored in Barman's WAL archive. Since all supported versions of PostgreSQL now have replication slots it is sufficient to configure only WAL streaming.</p>
</blockquote>
<h2 id="two-typical-scenarios-for-backups">Two typical scenarios for backups</h2>
<p>In order to make life easier for you, below we summarise the two most typical scenarios for a given PostgreSQL server in Barman.</p>
<p>Bear in mind that this is a decision that you must make for every single server that you decide to back up with Barman. This means that you can have heterogeneous setups within the same installation.</p>
<p>As mentioned before, we will only worry about the PostgreSQL server (<code>pg</code>) and the Barman server (<code>backup</code>). However, in real life, your architecture will most likely contain other technologies such as repmgr, pgBouncer, Nagios/Icinga, and so on.</p>
<h3 id="scenario-1-backup-via-streaming-protocol">Scenario 1: Backup via streaming protocol</h3>
<p>A streaming backup installation is recommended for most use cases - see figure  below.</p>
<!-- TODO: This way of referencing won't work in HTML -->
<figure>
<img src="images/barman-architecture-scenario1.png" alt="Streaming-only backup (Scenario 1)" style="width:80.0%" /><figcaption>Streaming-only backup (Scenario 1)</figcaption>
</figure>
<p>In this scenario, you will need to configure:</p>
<ol type="1">
<li>a standard connection to PostgreSQL, for management, coordination, and monitoring purposes</li>
<li>a streaming replication connection that will be used by both <code>pg_basebackup</code> (for base backup operations) and <code>pg_receivewal</code> (for WAL streaming)</li>
</ol>
<p>In Barman's terminology this setup is known as <strong>streaming-only</strong> setup as it does not use an SSH connection for backup and archiving operations. This is particularly suitable and extremely practical for Docker environments.</p>
<p>As discussed in <a href="#the-barman-wal-archive">&quot;The Barman WAL archive&quot;</a>, you can configure WAL archiving via SSH <em>in addition to</em> WAL streaming - see figure  below.</p>
<figure>
<img src="images/barman-architecture-scenario1b.png" alt="Streaming backup with WAL archiving (Scenario 1b)" style="width:80.0%" /><figcaption>Streaming backup with WAL archiving (Scenario 1b)</figcaption>
</figure>
<p>WAL archiving via SSH requires:</p>
<ul>
<li>an additional SSH connection that allows the <code>postgres</code> user on the PostgreSQL server to connect as <code>barman</code> user on the Barman server</li>
<li>the <code>archive_command</code> in PostgreSQL be configured to ship WAL files to Barman</li>
</ul>
<h3 id="scenario-2-backup-via-rsyncssh">Scenario 2: Backup via <code>rsync</code>/SSH</h3>
<p>An <code>rsync</code>/SSH backup installation is required for cases where the following features are required:</p>
<ul>
<li>file-level incremental backup</li>
<li>parallel backup</li>
<li>finer control of bandwidth usage, including on a per-tablespace basis</li>
</ul>
<figure>
<img src="images/barman-architecture-scenario2.png" alt="Scenario 2 - Backup via rsync/SSH" style="width:80.0%" /><figcaption>Scenario 2 - Backup via rsync/SSH</figcaption>
</figure>
<p>In this scenario, you will need to configure:</p>
<ol type="1">
<li>a standard connection to PostgreSQL for management, coordination, and monitoring purposes</li>
<li>an SSH connection for base backup operations to be used by <code>rsync</code> that allows the <code>barman</code> user on the Barman server to connect as <code>postgres</code> user on the PostgreSQL server</li>
<li>an SSH connection for WAL archiving to be used by the <code>archive_command</code> in PostgreSQL and that allows the <code>postgres</code> user on the PostgreSQL server to connect as <code>barman</code> user on the Barman server</li>
</ol>
<p>As an alternative to configuring WAL archiving in step 3, you can instead configure WAL streaming as described in <a href="#scenario-1-backup-via-streaming-protocol">Scenario 1</a>. This will use a streaming replication connection instead of <code>archive_command</code> and significantly reduce RPO. As with <a href="#scenario-1-backup-via-streaming-protocol">Scenario 1</a> it is also possible to configure both WAL streaming and WAL archiving as shown in figure  below.</p>
<figure>
<img src="images/barman-architecture-scenario2b.png" alt="Backup via rsync/SSH with WAL streaming (Scenario 2b)" style="width:80.0%" /><figcaption>Backup via rsync/SSH with WAL streaming (Scenario 2b)</figcaption>
</figure>
<!-- TODO - Add a section on architecture for recovery? -->

<h1 id="system-requirements">System requirements</h1>
<ul>
<li>Linux/Unix</li>
<li>Python &gt;= 3.4</li>
<li>Python modules:
<ul>
<li>argcomplete</li>
<li>psycopg2 &gt;= 2.4.2</li>
<li>python-dateutil</li>
<li>setuptools</li>
</ul></li>
<li>PostgreSQL &gt;= 10</li>
<li>rsync &gt;= 3.0.4 (optional)</li>
</ul>
<blockquote>
<p><strong>IMPORTANT:</strong> Users of RedHat Enterprise Linux, CentOS and Scientific Linux are required to install the <a href="https://fedoraproject.org/wiki/EPEL">Extra Packages Enterprise Linux (EPEL) repository</a>.</p>
</blockquote>
<blockquote>
<p><strong>NOTE:</strong> Support for Python 2.6 and 2.7 is deprecated and will be discontinued in future releases. Support for PostgreSQL &lt;= 9.5 is discontinued Support for PostgreSQL &lt; 9.6 is deprecated and will be discontinued in future releases.</p>
</blockquote>
<h2 id="requirements-for-backup">Requirements for backup</h2>
<p>The most critical requirement for a Barman server is the amount of disk space available. You are recommended to plan the required disk space based on the size of the cluster, number of WAL files generated per day, frequency of backups, and retention policies.</p>
<p>Barman developers regularly test Barman with XFS and ext4. Like <a href="https://www.postgresql.org/docs/current/creating-cluster.html#CREATING-CLUSTER-FILESYSTEM">PostgreSQL</a>, Barman does nothing special for NFS. The following points are required for safely using Barman with NFS: * The <code>barman_lock_directory</code> should be on a non-network filesystem. * Use version 4 of the NFS protocol. * The file system must be mounted using the hard and synchronous options (<code>hard,sync</code>).</p>
<h2 id="requirements-for-recovery">Requirements for recovery</h2>
<p>Barman allows you to recover a PostgreSQL instance either locally (where Barman resides) or remotely (on a separate server).</p>
<p>Remote recovery is definitely the most common way to restore a PostgreSQL server with Barman.</p>
<p>Either way, the same <a href="https://www.postgresql.org/docs/current/static/warm-standby.html#STANDBY-PLANNING">requirements for PostgreSQL's Log shipping and Point-In-Time-Recovery apply</a>:</p>
<ul>
<li>identical hardware architecture</li>
<li>identical major version of PostgreSQL</li>
</ul>
<p>In general, it is <strong>highly recommended</strong> to create recovery environments that are as similar as possible, if not identical, to the original server, because they are easier to maintain. For example, we suggest that you use the same operating system, the same PostgreSQL version, the same disk layouts, and so on.</p>
<p>Additionally, dedicated recovery environments for each PostgreSQL server, even on demand, allows you to nurture the disaster recovery culture in your team. You can be prepared for when something unexpected happens by practising recovery operations and becoming familiar with them.</p>
<p>Based on our experience, designated recovery environments reduce the impact of stress in real failure situations, and therefore increase the effectiveness of recovery operations.</p>
<p>Finally, it is important that time is synchronised between the servers, using NTP for example.</p>

<h1 id="installation">Installation</h1>
<p>Official packages for Barman are distributed by EnterpriseDB through repositories listed on the <a href="https://pgbarman.org/downloads/">Barman downloads page</a>.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> The recommended way to install Barman is by using the available packages for your GNU/Linux distribution.</p>
</blockquote>
<h2 id="installation-on-redhatcentos-using-rpm-packages">Installation on RedHat/CentOS using RPM packages</h2>
<p>Barman can be installed on RHEL7 and RHEL6 Linux systems using RPM packages. It is required to install the Extra Packages Enterprise Linux (EPEL) repository and the <a href="https://yum.postgresql.org/">PostgreSQL Global Development Group RPM repository</a> beforehand.</p>
<p>Official RPM packages for Barman are distributed by EnterpriseDB via Yum through the <a href="https://rpm.2ndquadrant.com/">public RPM repository</a>, by following the instructions you find on that website.</p>
<p>Then, as <code>root</code> simply type:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="ex">yum</span> install barman</a></code></pre></div>
<blockquote>
<p><strong>NOTE: </strong> We suggest that you exclude any Barman related packages from getting updated via the PGDG repository. This can be done by adding the following line to any PGDG repository definition that is included in the Barman server inside any <code>/etc/yum.repos.d/pgdg-*.repo</code> file:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="dt">exclude</span><span class="ot">=</span><span class="st">barman* python*-barman</span></a></code></pre></div>
<p>By doing this, you solely rely on EnterpriseDB repositories for package management of Barman software.</p>
</blockquote>
<h2 id="installation-on-debianubuntu-using-packages">Installation on Debian/Ubuntu using packages</h2>
<p>Barman can be installed on Debian and Ubuntu Linux systems using packages.</p>
<p>It is directly available in the official repository for Debian and Ubuntu, however, these repositories might not contain the latest available version. If you want to have the latest version of Barman, the recommended method is to install both these repositories:</p>
<ul>
<li><a href="https://apt.2ndquadrant.com/">Public APT repository</a>, directly maintained by Barman developers</li>
<li>the <a href="https://apt.postgresql.org/">PostgreSQL Community APT repository</a>, by following instructions in the <a href="https://wiki.postgresql.org/wiki/Apt">APT section of the PostgreSQL Wiki</a></li>
</ul>
<blockquote>
<p><strong>NOTE:</strong> Thanks to the direct involvement of Barman developers in the PostgreSQL Community APT repository project, you will always have access to the most updated versions of Barman.</p>
</blockquote>
<p>Installing Barman is as easy. As <code>root</code> user simply type:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="ex">apt-get</span> install barman</a></code></pre></div>
<h2 id="installation-on-sles-using-packages">Installation on SLES using packages</h2>
<p>Barman can be installed on SLES systems using packages available in the <a href="https://zypp.postgresql.org/">PGDG SLES repositories</a>. Install the necessary repository by following the instructions available on the <a href="https://zypp.postgresql.org/howtozypp/">PGDG site</a>.</p>
<p>Supported SLES versions are SLES 12 SP5 and SLES 15 SP3.</p>
<p><em>SLES 12 only</em>: You will also need to enable OpenSUSE python backports repositories as follows (this step is not necessary for SLES 15):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="ex">zypper</span> addrepo https://download.opensuse.org/repositories/devel:languages:python:backports/SLE_12_SP5/devel:languages:python:backports.repo</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="ex">zypper</span> addrepo https://download.opensuse.org/repositories/devel:/languages:/python:/backports/SLE_12_SP4 devel_languages_python_backports_sp4</a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="ex">zypper</span> refresh</a></code></pre></div>
<p>Once the necessary repositories have been installed you can install Barman as the <code>root</code> user:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="ex">zypper</span> install barman</a></code></pre></div>
<h2 id="installation-from-sources">Installation from sources</h2>
<blockquote>
<p><strong>WARNING:</strong> Manual installation of Barman from sources should only be performed by expert GNU/Linux users. Installing Barman this way requires system administration activities such as dependencies management, <code>barman</code> user creation, configuration of the <code>barman.conf</code> file, cron setup for the <code>barman cron</code> command, log management, and so on.</p>
</blockquote>
<p>Create a system user called <code>barman</code> on the <code>backup</code> server. As <code>barman</code> user, download the sources and uncompress them.</p>
<p>For a system-wide installation, type:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="ex">barman@backup</span>$ ./setup.py build</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co"># run this command with root privileges or through sudo</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="ex">barman@backup</span># ./setup.py install</a></code></pre></div>
<p>For a local installation, type:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="ex">barman@backup</span>$ ./setup.py install --user</a></code></pre></div>
<p>The <code>barman</code> application will be installed in your user directory (<a href="https://docs.python.org/3/install/index.html#alternate-installation-the-user-scheme">make sure that your <code>PATH</code> environment variable is set properly</a>).</p>
<p><a href="https://pypi.python.org/pypi/barman/">Barman is also available on the Python Package Index (PyPI)</a> and can be installed through <code>pip</code>.</p>
<h2 id="postgresql-clientserver-binaries">PostgreSQL client/server binaries</h2>
<p>The following Barman features depend on PostgreSQL binaries:</p>
<ul>
<li><a href="#streaming-backup">Streaming backup</a> with <code>backup_method = postgres</code> (requires <code>pg_basebackup</code>)</li>
<li><a href="#wal-streaming">Streaming WAL archiving</a> with <code>streaming_archiver = on</code> (requires <code>pg_receivewal</code> or <code>pg_receivexlog</code>)</li>
<li><a href="#verify">Verifying backups</a> with <code>barman verify-backup</code> (requires <code>pg_verifybackup</code>)</li>
</ul>
<p>Depending on the target OS these binaries are installed with either the PostgreSQL client or server packages:</p>
<ul>
<li>On RedHat/CentOS and SLES:
<ul>
<li>The <code>pg_basebackup</code> and <code>pg_receivewal</code>/<code>pg_receivexlog</code> binaries are installed with the PostgreSQL client packages.</li>
<li>The <code>pg_verifybackup</code> binary is installed with the PostgreSQL server packages.</li>
<li>All binaries are installed in <code>/usr/pgsql-${PG_MAJOR_VERSION}/bin</code>.</li>
</ul></li>
<li>On Debian/Ubuntu:
<ul>
<li>All binaries are installed with the PostgreSQL client packages.</li>
<li>The binaries are installed in <code>/usr/lib/postgresql/${PG_MAJOR_VERSION}/bin</code>.</li>
</ul></li>
</ul>
<p>You must ensure that either:</p>
<ol type="1">
<li>The Barman user has the <code>bin</code> directory for the appropriate <code>PG_MAJOR_VERSION</code> on its path, or:</li>
<li>The <a href="#binary-paths">path_prefix</a> option is set in the Barman configuration for each server and points to the <code>bin</code> directory for the appropriate <code>PG_MAJOR_VERSION</code>.</li>
</ol>
<p>The <a href="https://www.postgresql.org/docs/current/app-psql.html">psql</a> program is recommended in addition to the above binaries. While Barman does not use it directly the documentation provides examples of how it can be used to verify PostgreSQL connections are working as intended. The <code>psql</code> binary can be found in the PostgreSQL client packages.</p>
<h1 id="upgrading-barman">Upgrading Barman</h1>
<p>Barman follows the trunk-based development paradigm, and as such there is only one stable version, the latest. After every commit, Barman goes through thousands of automated tests for each supported PostgreSQL version and on each supported Linux distribution.</p>
<p>Also, <strong>every version is back compatible</strong> with previous ones. Therefore, upgrading Barman normally requires a simple update of packages using <code>yum update</code> or <code>apt update</code>.</p>
<p>There have been, however, the following exceptions in our development history, which required some small changes to the configuration.</p>
<h2 id="upgrading-to-barman-3.0.0">Upgrading to Barman 3.0.0</h2>
<h3 id="default-backup-approach-for-rsync-backups-is-now-concurrent">Default backup approach for Rsync backups is now concurrent</h3>
<p>Barman will now use concurrent backups if neither <code>concurrent_backup</code> nor <code>exclusive_backup</code> are specified in <code>backup_options</code>. This differs from previous Barman versions where the default was to use exclusive backup.</p>
<p>If you require exclusive backups you will now need to add <code>exclusive_backup</code> to <code>backup_options</code> in the Barman configuration.</p>
<p>Note that exclusive backups are not supported at all when running against PostgreSQL 15.</p>
<h3 id="metadata-changes">Metadata changes</h3>
<p>A new field named <code>compression</code> will be added to the metadata stored in the <code>backup.info</code> file for all backups taken with version 3.0.0. This is used when recovering from backups taken using the built-in compression functionality of <code>pg_basebackup</code>.</p>
<p>The presence of this field means that earlier versions of Barman are not able to read backups taken with Barman 3.0.0. This means that if you downgrade from Barman 3.0.0 to an earlier version you will have to either manually remove any backups taken with 3.0.0 or edit the <code>backup.info</code> file of each backup to remove the <code>compression</code> field.</p>
<p>The same metadata change affects <a href="https://github.com/EnterpriseDB/pg-backup-api">pg-backup-api</a> so if you are using pg-backup-api you will need to update it to version 0.2.0.</p>
<h2 id="upgrading-from-barman-2.10">Upgrading from Barman 2.10</h2>
<p>If you are using <code>barman-cloud-wal-archive</code> or <code>barman-cloud-backup</code> you need to be aware that from version 2.11 all cloud utilities have been moved into the new <code>barman-cli-cloud</code> package. Therefore, you need to ensure that the <code>barman-cli-cloud</code> package is properly installed as part of the upgrade to the latest version. If you are not using the above tools, you can upgrade to the latest version as usual.</p>
<h2 id="upgrading-from-barman-2.x-prior-to-2.8">Upgrading from Barman 2.X (prior to 2.8)</h2>
<p>Before upgrading from a version of Barman 2.7 or older users of <code>rsync</code> backup method on a primary server should explicitly set <code>backup_options</code> to either <code>concurrent_backup</code> (recommended for PostgreSQL 9.6 or higher) or <code>exclusive_backup</code> (current default), otherwise Barman emits a warning every time it runs.</p>
<h2 id="upgrading-from-barman-1.x">Upgrading from Barman 1.X</h2>
<p>If your Barman installation is 1.X, you need to explicitly configure the archiving strategy. Before, the file based archiver, controlled by <code>archiver</code>, was enabled by default.</p>
<p>Before you upgrade your Barman installation to the latest version, make sure you add the following line either globally or for any server that requires it:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="dt">archiver </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></a></code></pre></div>
<p>Additionally, for a few releases, Barman will transparently set <code>archiver = on</code> with any server that has not explicitly set an archiving strategy and emit a warning.</p>

<h1 id="configuration">Configuration</h1>
<p>There are two types of configuration files in Barman:</p>
<ul>
<li><strong>global/general configuration</strong></li>
<li><strong>server configuration</strong></li>
</ul>
<p>The main configuration file (set to <code>/etc/barman.conf</code> by default) contains general options such as main directory, system user, log file, and so on.</p>
<p>Server configuration files, one for each server to be backed up by Barman, are located in the <code>/etc/barman.d</code> directory and must have a <code>.conf</code> suffix.</p>
<blockquote>
<p><strong>IMPORTANT</strong>: For historical reasons, you can still have one single configuration file containing both global and server options. However, for maintenance reasons, this approach is deprecated.</p>
</blockquote>
<p>Configuration files in Barman follow the <em>INI</em> format.</p>
<p>Configuration files accept distinct types of parameters:</p>
<ul>
<li>string</li>
<li>enum</li>
<li>integer</li>
<li>boolean, <code>on/true/1</code> are accepted as well are <code>off/false/0</code>.</li>
</ul>
<p>None of them requires to be quoted.</p>
<blockquote>
<p><em>NOTE</em>: some <code>enum</code> allows <code>off</code> but not <code>false</code>.</p>
</blockquote>
<h2 id="options-scope">Options scope</h2>
<p>Every configuration option has a <em>scope</em>:</p>
<ul>
<li>global</li>
<li>server</li>
<li>global/server: server options that can be generally set at global level</li>
</ul>
<p>Global options are allowed in the <em>general section</em>, which is identified in the INI file by the <code>[barman]</code> label:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">[barman]</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"><span class="co">; ... global and global/server options go here</span></a></code></pre></div>
<p>Server options can only be specified in a <em>server section</em>, which is identified by a line in the configuration file, in square brackets (<code>[</code> and <code>]</code>). The server section represents the ID of that server in Barman. The following example specifies a section for the server named <code>pg</code>:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="kw">[pg]</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="co">; Configuration options for the</span></a>
<a class="sourceLine" id="cb10-3" data-line-number="3"><span class="co">; server named &#39;pg&#39; go here</span></a></code></pre></div>
<p>There are two reserved words that cannot be used as server names in Barman:</p>
<ul>
<li><code>barman</code>: identifier of the global section</li>
<li><code>all</code>: a handy shortcut that allows you to execute some commands on every server managed by Barman in sequence</li>
</ul>
<p>Barman implements the <strong>convention over configuration</strong> design paradigm, which attempts to reduce the number of options that you are required to configure without losing flexibility. Therefore, some server options can be defined at global level and overridden at server level, allowing users to specify a generic behavior and refine it for one or more servers. These options have a global/server scope.</p>
<p>For a list of all the available configurations and their scope, please refer to <a href="https://docs.pgbarman.org/barman.5.html">section 5 of the 'man' page</a>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="fu">man</span> 5 barman</a></code></pre></div>
<h2 id="examples-of-configuration">Examples of configuration</h2>
<p>The following is a basic example of main configuration file:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">[barman]</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="dt">barman_user </span><span class="ot">=</span><span class="st"> barman</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="dt">configuration_files_directory </span><span class="ot">=</span><span class="st"> /etc/barman.d</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="dt">barman_home </span><span class="ot">=</span><span class="st"> /var/lib/barman</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="dt">log_file </span><span class="ot">=</span><span class="st"> /var/log/barman/barman.log</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="dt">log_level </span><span class="ot">=</span><span class="st"> INFO</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="dt">compression </span><span class="ot">=</span><span class="st"> gzip</span></a></code></pre></div>
<p>The example below, on the other hand, is a server configuration file that uses streaming backup:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb13-1" data-line-number="1"><span class="kw">[streaming-pg]</span></a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="dt">description </span><span class="ot">=</span><span class="st">  &quot;Example of PostgreSQL Database (Streaming-Only)&quot;</span></a>
<a class="sourceLine" id="cb13-3" data-line-number="3"><span class="dt">conninfo </span><span class="ot">=</span><span class="st"> host=pg user=barman dbname=postgres</span></a>
<a class="sourceLine" id="cb13-4" data-line-number="4"><span class="dt">streaming_conninfo </span><span class="ot">=</span><span class="st"> host=pg user=streaming_barman</span></a>
<a class="sourceLine" id="cb13-5" data-line-number="5"><span class="dt">backup_method </span><span class="ot">=</span><span class="st"> postgres</span></a>
<a class="sourceLine" id="cb13-6" data-line-number="6"><span class="dt">streaming_archiver </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"><span class="dt">slot_name </span><span class="ot">=</span><span class="st"> barman</span></a></code></pre></div>
<p>The following code shows a basic example of traditional backup using <code>rsync</code>/SSH:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw">[ssh-pg]</span></a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="dt">description </span><span class="ot">=</span><span class="st">  &quot;Example of PostgreSQL Database (via Ssh)&quot;</span></a>
<a class="sourceLine" id="cb14-3" data-line-number="3"><span class="dt">ssh_command </span><span class="ot">=</span><span class="st"> ssh postgres@pg</span></a>
<a class="sourceLine" id="cb14-4" data-line-number="4"><span class="dt">conninfo </span><span class="ot">=</span><span class="st"> host=pg user=barman dbname=postgres</span></a>
<a class="sourceLine" id="cb14-5" data-line-number="5"><span class="dt">backup_method </span><span class="ot">=</span><span class="st"> rsync</span></a>
<a class="sourceLine" id="cb14-6" data-line-number="6"><span class="dt">parallel_jobs </span><span class="ot">=</span><span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"><span class="dt">reuse_backup </span><span class="ot">=</span><span class="st"> link</span></a>
<a class="sourceLine" id="cb14-8" data-line-number="8"><span class="dt">archiver </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></a></code></pre></div>
<p>For more detailed information, please refer to the distributed <code>barman.conf</code> file, as well as the <code>ssh-server.conf-template</code> and <code>streaming-server.conf-template</code> template files.</p>

<h1 id="setup-of-a-new-server-in-barman">Setup of a new server in Barman</h1>
<p>As mentioned in the <em>&quot;Design and architecture&quot;</em> section, we will use the following conventions:</p>
<ul>
<li><code>pg</code> as server ID and host name where PostgreSQL is installed</li>
<li><code>backup</code> as host name where Barman is located</li>
<li><code>barman</code> as the user running Barman on the <code>backup</code> server (identified by the parameter <code>barman_user</code> in the configuration)</li>
<li><code>postgres</code> as the user running PostgreSQL on the <code>pg</code> server</li>
</ul>
<blockquote>
<p><strong>IMPORTANT:</strong> a server in Barman must refer to the same PostgreSQL instance for the whole backup and recoverability history (i.e. the same system identifier). <strong>This means that if you perform an upgrade of the instance (using for example <code>pg_upgrade</code>, you must not reuse the same server definition in Barman, rather use another one as they have nothing in common.</strong></p>
</blockquote>
<h2 id="preliminary-steps">Preliminary steps</h2>
<p>This section contains some preliminary steps that you need to undertake before setting up your PostgreSQL server in Barman.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> Before you proceed, it is important that you have made your decision in terms of WAL archiving and backup strategies, as outlined in the <em>&quot;Design and architecture&quot;</em> section. In particular, you should decide which WAL archiving methods to use, as well as the backup method.</p>
</blockquote>
<h3 id="postgresql-connection">PostgreSQL connection</h3>
<p>You need to make sure that the <code>backup</code> server can connect to the PostgreSQL server on <code>pg</code> as superuser or, that the correct set of privileges are granted to the user that connects to the database.</p>
<p>You can create a specific superuser in PostgreSQL, named <code>barman</code>, as follows:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb15-1" data-line-number="1"><span class="ex">postgres@pg</span>$ createuser -s -P barman</a></code></pre></div>
<p>Or create a normal user with the required set of privileges as follows:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb16-1" data-line-number="1"><span class="ex">postgres@pg</span>$ createuser -P barman</a></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">GRANT</span> <span class="kw">EXECUTE</span> <span class="kw">ON</span> <span class="kw">FUNCTION</span> pg_start_backup(text, <span class="dt">boolean</span>, <span class="dt">boolean</span>) <span class="kw">to</span> barman;</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="kw">GRANT</span> <span class="kw">EXECUTE</span> <span class="kw">ON</span> <span class="kw">FUNCTION</span> pg_stop_backup() <span class="kw">to</span> barman;</a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="kw">GRANT</span> <span class="kw">EXECUTE</span> <span class="kw">ON</span> <span class="kw">FUNCTION</span> pg_stop_backup(<span class="dt">boolean</span>, <span class="dt">boolean</span>) <span class="kw">to</span> barman;</a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="kw">GRANT</span> <span class="kw">EXECUTE</span> <span class="kw">ON</span> <span class="kw">FUNCTION</span> pg_switch_wal() <span class="kw">to</span> barman;</a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="kw">GRANT</span> <span class="kw">EXECUTE</span> <span class="kw">ON</span> <span class="kw">FUNCTION</span> pg_create_restore_point(text) <span class="kw">to</span> barman;</a>
<a class="sourceLine" id="cb17-6" data-line-number="6"></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="kw">GRANT</span> pg_read_all_settings <span class="kw">TO</span> barman;</a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="kw">GRANT</span> pg_read_all_stats <span class="kw">TO</span> barman;</a></code></pre></div>
<p>In the PostgreSQL 15 beta and any subsequent PostgreSQL versions the functions <code>pg_start_backup</code> and <code>pg_stop_backup</code> have been renamed and have different signatures. You will therefore need to replace the first three lines in the above block with:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode sql"><code class="sourceCode sql"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">GRANT</span> <span class="kw">EXECUTE</span> <span class="kw">ON</span> <span class="kw">FUNCTION</span> pg_backup_start(text, <span class="dt">boolean</span>) <span class="kw">to</span> barman;</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="kw">GRANT</span> <span class="kw">EXECUTE</span> <span class="kw">ON</span> <span class="kw">FUNCTION</span> pg_backup_stop(<span class="dt">boolean</span>) <span class="kw">to</span> barman;</a></code></pre></div>
<p>It is worth noting that without a real superuser, the <code>--force</code> option of the <code>barman switch-wal</code> command will not work.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> The above <code>createuser</code> command will prompt for a password, which you are then advised to add to the <code>~barman/.pgpass</code> file on the <code>backup</code> server. For further information, please refer to <a href="https://www.postgresql.org/docs/current/static/libpq-pgpass.html">&quot;The Password File&quot; section in the PostgreSQL Documentation</a>.</p>
</blockquote>
<p>This connection is required by Barman in order to coordinate its activities with the server, as well as for monitoring purposes.</p>
<p>You can choose your favourite client authentication method among those offered by PostgreSQL. More information can be found in the <a href="https://www.postgresql.org/docs/current/static/client-authentication.html">&quot;Client Authentication&quot; section of the PostgreSQL Documentation</a>.</p>
<p>Run the following command as the barman user on the <code>backup</code> host in order to verify that the <code>backup</code> host can connect to PostgreSQL on the <code>pg</code> host:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="ex">barman@backup</span>$ psql -c <span class="st">&#39;SELECT version()&#39;</span> -U barman -h pg postgres</a></code></pre></div>
<p>Write down the above information (user name, host name and database name) and keep it for later. You will need it with in the <code>conninfo</code> option for your server configuration, like in this example:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw">[pg]</span></a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="co">; ...</span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="dt">conninfo </span><span class="ot">=</span><span class="st"> host=pg user=barman dbname=postgres application_name=myapp</span></a></code></pre></div>
<blockquote>
<p><strong>NOTE:</strong> <code>application_name</code> is optional.</p>
</blockquote>
<h3 id="postgresql-wal-archiving-and-replication">PostgreSQL WAL archiving and replication</h3>
<p>Before you proceed, you need to properly configure PostgreSQL on <code>pg</code> to accept streaming replication connections from the Barman server. Please read the following sections in the PostgreSQL documentation:</p>
<ul>
<li><a href="https://www.postgresql.org/docs/current/static/role-attributes.html">Role attributes</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/auth-pg-hba-conf.html">The pg_hba.conf file</a></li>
<li><a href="https://www.postgresql.org/docs/current/static/protocol-replication.html">Setting up standby servers using streaming replication</a></li>
</ul>
<p>One configuration parameter that is crucially important is the <code>wal_level</code> parameter. This parameter must be configured to ensure that all the useful information necessary for a backup to be coherent are included in the transaction log file.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb21-1" data-line-number="1"><span class="dt">wal_level </span><span class="ot">=</span><span class="st"> &#39;replica&#39;|&#39;logical&#39;</span></a></code></pre></div>
<p>Restart the PostgreSQL server for the configuration to be refreshed.</p>
<h3 id="postgresql-streaming-connection">PostgreSQL streaming connection</h3>
<p>If you plan to use WAL streaming or streaming backup, you need to setup a streaming connection. We recommend creating a specific user in PostgreSQL, named <code>streaming_barman</code>, as follows:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb22-1" data-line-number="1"><span class="ex">postgres@pg</span>$ createuser -P --replication streaming_barman</a></code></pre></div>
<blockquote>
<p><strong>IMPORTANT:</strong> The above command will prompt for a password, which you are then advised to add to the <code>~barman/.pgpass</code> file on the <code>backup</code> server. For further information, please refer to <a href="https://www.postgresql.org/docs/current/static/libpq-pgpass.html">&quot;The Password File&quot; section in the PostgreSQL Documentation</a>.</p>
</blockquote>
<p>You can manually verify that the streaming connection works through the following command:</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb23-1" data-line-number="1"><span class="ex">barman@backup</span>$ psql -U streaming_barman -h pg \</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">  -c <span class="st">&quot;IDENTIFY_SYSTEM&quot;</span> \</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">  replication=1</a></code></pre></div>
<p>If the connection is working you should see a response containing the system identifier, current timeline ID and current WAL flush location, for example:</p>
<pre><code>      systemid       | timeline |  xlogpos   | dbname
---------------------+----------+------------+--------
 7139870358166741016 |        1 | 1/330000D8 |
(1 row)</code></pre>
<blockquote>
<p><strong>IMPORTANT:</strong> Please make sure you are able to connect via streaming replication before going any further.</p>
</blockquote>
<p>You also need to configure the <code>max_wal_senders</code> parameter in the PostgreSQL configuration file. The number of WAL senders depends on the PostgreSQL architecture you have implemented. In this example, we are setting it to <code>2</code>:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb25-1" data-line-number="1"><span class="dt">max_wal_senders </span><span class="ot">=</span><span class="st"> </span><span class="dv">2</span></a></code></pre></div>
<p>This option represents the maximum number of concurrent streaming connections that the server will be allowed to manage.</p>
<p>Another important parameter is <code>max_replication_slots</code>, which represents the maximum number of replication slots <a href="#fn5" class="footnote-ref" id="fnref5"><sup>5</sup></a> that the server will be allowed to manage. This parameter is needed if you are planning to use the streaming connection to receive WAL files over the streaming connection:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="dt">max_replication_slots </span><span class="ot">=</span><span class="st"> </span><span class="dv">2</span></a></code></pre></div>
<p>The values proposed for <code>max_replication_slots</code> and <code>max_wal_senders</code> must be considered as examples, and the values you will use in your actual setup must be chosen after a careful evaluation of the architecture. Please consult the PostgreSQL documentation for guidelines and clarifications.</p>
<h3 id="ssh-connections">SSH connections</h3>
<p>SSH is a protocol and a set of tools that allows you to open a remote shell to a remote server and copy files between the server and the local system. You can find more documentation about SSH usage in the article <a href="https://www.digitalocean.com/community/tutorials/ssh-essentials-working-with-ssh-servers-clients-and-keys">&quot;SSH Essentials&quot;</a> by Digital Ocean.</p>
<p>SSH key exchange is a very common practice that is used to implement secure passwordless connections between users on different machines, and it's needed to use <code>rsync</code> for WAL archiving and for backups.</p>
<blockquote>
<p><strong>NOTE:</strong> This procedure is not needed if you plan to use the streaming connection only to archive transaction logs and backup your PostgreSQL server.</p>
</blockquote>
<h4 id="ssh-configuration-of-postgres-user">SSH configuration of postgres user</h4>
<p>Unless you have done it before, you need to create an SSH key for the PostgreSQL user. Log in as <code>postgres</code>, in the <code>pg</code> host and type:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb27-1" data-line-number="1"><span class="ex">postgres@pg</span>$ ssh-keygen -t rsa</a></code></pre></div>
<p>As this key must be used to connect from hosts without providing a password, no passphrase should be entered during the key pair creation.</p>
<h4 id="ssh-configuration-of-barman-user">SSH configuration of barman user</h4>
<p>As in the previous paragraph, you need to create an SSH key for the Barman user. Log in as <code>barman</code> in the <code>backup</code> host and type:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb28-1" data-line-number="1"><span class="ex">barman@backup</span>$ ssh-keygen -t rsa</a></code></pre></div>
<p>For the same reason, no passphrase should be entered.</p>
<h4 id="from-postgresql-to-barman">From PostgreSQL to Barman</h4>
<p>The SSH connection from the PostgreSQL server to the backup server is needed to correctly archive WAL files using the <code>archive_command</code> setting.</p>
<p>To successfully connect from the PostgreSQL server to the backup server, the PostgreSQL public key has to be configured into the authorized keys of the backup server for the <code>barman</code> user.</p>
<p>The public key to be authorized is stored inside the <code>postgres</code> user home directory in a file named <code>.ssh/id_rsa.pub</code>, and its content should be included in a file named <code>.ssh/authorized_keys</code> inside the home directory of the <code>barman</code> user in the backup server. If the <code>authorized_keys</code> file doesn't exist, create it using <code>600</code> as permissions.</p>
<p>The following command should succeed without any output if the SSH key pair exchange has been completed successfully:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb29-1" data-line-number="1"><span class="ex">postgres@pg</span>$ ssh barman@backup -C true</a></code></pre></div>
<p>The value of the <code>archive_command</code> configuration parameter will be discussed in the <em>&quot;WAL archiving via archive_command section&quot;</em>.</p>
<h4 id="from-barman-to-postgresql">From Barman to PostgreSQL</h4>
<p>The SSH connection between the backup server and the PostgreSQL server is used for the traditional backup over rsync. Just as with the connection from the PostgreSQL server to the backup server, we should authorize the public key of the backup server in the PostgreSQL server for the <code>postgres</code> user.</p>
<p>The content of the file <code>.ssh/id_rsa.pub</code> in the <code>barman</code> server should be put in the file named <code>.ssh/authorized_keys</code> in the PostgreSQL server. The permissions of that file should be <code>600</code>.</p>
<p>The following command should succeed without any output if the key pair exchange has been completed successfully.</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="ex">barman@backup</span>$ ssh postgres@pg -C true</a></code></pre></div>
<h2 id="the-server-configuration-file">The server configuration file</h2>
<p>Create a new file, called <code>pg.conf</code>, in <code>/etc/barman.d</code> directory, with the following content:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb31-1" data-line-number="1"><span class="kw">[pg]</span></a>
<a class="sourceLine" id="cb31-2" data-line-number="2"><span class="dt">description </span><span class="ot">=</span><span class="st">  &quot;Our main PostgreSQL server&quot;</span></a>
<a class="sourceLine" id="cb31-3" data-line-number="3"><span class="dt">conninfo </span><span class="ot">=</span><span class="st"> host=pg user=barman dbname=postgres</span></a>
<a class="sourceLine" id="cb31-4" data-line-number="4"><span class="dt">backup_method </span><span class="ot">=</span><span class="st"> postgres</span></a>
<a class="sourceLine" id="cb31-5" data-line-number="5"><span class="co"># backup_method = rsync</span></a></code></pre></div>
<p>The <code>conninfo</code> option is set accordingly to the section <em>&quot;Preliminary steps: PostgreSQL connection&quot;</em>.</p>
<p>The meaning of the <code>backup_method</code> option will be covered in the backup section of this guide.</p>
<p>If you plan to use the streaming connection for WAL archiving or to create a backup of your server, you also need a <code>streaming_conninfo</code> parameter in your server configuration file:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb32-1" data-line-number="1"><span class="dt">streaming_conninfo </span><span class="ot">=</span><span class="st"> host=pg user=streaming_barman dbname=postgres</span></a></code></pre></div>
<p>This value must be chosen accordingly as described in the section <em>&quot;Preliminary steps: PostgreSQL connection&quot;</em>.</p>
<h2 id="wal-streaming">WAL streaming</h2>
<p>Barman can reduce the Recovery Point Objective (RPO) by allowing users to add continuous WAL streaming from a PostgreSQL server, on top of the standard <code>archive_command</code> strategy.</p>
<p>Barman relies on <a href="https://www.postgresql.org/docs/current/static/app-pgreceivewal.html"><code>pg_receivewal</code></a>, it exploits the native streaming replication protocol and continuously receives transaction logs from a PostgreSQL server (master or standby). Prior to PostgreSQL 10, <code>pg_receivewal</code> was named <code>pg_receivexlog</code>.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> Barman requires that <code>pg_receivewal</code> is installed on the same server. It is recommended to install the latest available version of <code>pg_receivewal</code>, as it is back compatible. Otherwise, users can install multiple versions of <code>pg_receivewal</code> on the Barman server and properly point to the specific version for a server, using the <code>path_prefix</code> option in the configuration file.</p>
</blockquote>
<p>In order to enable streaming of transaction logs, you need to:</p>
<ol type="1">
<li>setup a streaming connection as previously described</li>
<li>set the <code>streaming_archiver</code> option to <code>on</code></li>
</ol>
<p>The <code>cron</code> command, if the aforementioned requirements are met, transparently manages log streaming through the execution of the <code>receive-wal</code> command. This is the recommended scenario.</p>
<p>However, users can manually execute the <code>receive-wal</code> command:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb33-1" data-line-number="1"><span class="ex">barman</span> receive-wal <span class="op">&lt;</span>server_name<span class="op">&gt;</span></a></code></pre></div>
<blockquote>
<p><strong>NOTE:</strong> The <code>receive-wal</code> command is a foreground process.</p>
</blockquote>
<p>Transaction logs are streamed directly in the directory specified by the <code>streaming_wals_directory</code> configuration option and are then archived by the <code>archive-wal</code> command.</p>
<p>Unless otherwise specified in the <code>streaming_archiver_name</code> parameter, Barman will set <code>application_name</code> of the WAL streamer process to <code>barman_receive_wal</code>, allowing you to monitor its status in the <code>pg_stat_replication</code> system view of the PostgreSQL server.</p>
<h3 id="replication-slots">Replication slots</h3>
<p>Replication slots are an automated way to ensure that the PostgreSQL server will not remove WAL files until they were received by all archivers. Barman uses this mechanism to receive the transaction logs from PostgreSQL.</p>
<p>You can find more information about replication slots in the <a href="https://www.postgresql.org/docs/current/static/warm-standby.html#STREAMING-REPLICATION-SLOTS">PostgreSQL manual</a>.</p>
<p>You can even base your backup architecture on streaming connection only. This scenario is useful to configure Docker-based PostgreSQL servers and even to work with PostgreSQL servers running on Windows.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> At this moment, the Windows support is still experimental, as it is not yet part of our continuous integration system.</p>
</blockquote>
<h3 id="how-to-configure-the-wal-streaming">How to configure the WAL streaming</h3>
<p>First, the PostgreSQL server must be configured to stream the transaction log files to the Barman server.</p>
<p>To configure the streaming connection from Barman to the PostgreSQL server you need to enable the <code>streaming_archiver</code>, as already said, including this line in the server configuration file:</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="dt">streaming_archiver </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></a></code></pre></div>
<p>If you plan to use replication slots (recommended), another essential option for the setup of the streaming-based transaction log archiving is the <code>slot_name</code> option:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb35-1" data-line-number="1"><span class="dt">slot_name </span><span class="ot">=</span><span class="st"> barman</span></a></code></pre></div>
<p>This option defines the name of the replication slot that will be used by Barman. It is mandatory if you want to use replication slots.</p>
<p>When you configure the replication slot name, you can manually create a replication slot for Barman with this command:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb36-1" data-line-number="1"><span class="ex">barman@backup</span>$ barman receive-wal --create-slot pg</a>
<a class="sourceLine" id="cb36-2" data-line-number="2"><span class="ex">Creating</span> physical replication slot <span class="st">&#39;barman&#39;</span> on server <span class="st">&#39;pg&#39;</span></a>
<a class="sourceLine" id="cb36-3" data-line-number="3"><span class="ex">Replication</span> slot <span class="st">&#39;barman&#39;</span> created</a></code></pre></div>
<p>Starting with Barman 2.10, you can configure Barman to automatically create the replication slot by setting:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb37-1" data-line-number="1"><span class="dt">create_slot </span><span class="ot">=</span><span class="st"> auto</span></a></code></pre></div>
<h3 id="limitations-of-partial-wal-files-with-recovery">Limitations of partial WAL files with recovery</h3>
<p>The standard behaviour of <code>pg_receivewal</code> is to write transactional information in a file with <code>.partial</code> suffix after the WAL segment name.</p>
<p>Barman expects a partial file to be in the <code>streaming_wals_directory</code> of a server. When completed, <code>pg_receivewal</code> removes the <code>.partial</code> suffix and opens the following one, delivering the file to the <code>archive-wal</code> command of Barman for permanent storage and compression.</p>
<p>In case of a sudden and unrecoverable failure of the master PostgreSQL server, the <code>.partial</code> file that has been streamed to Barman contains very important information that the standard archiver (through PostgreSQL's <code>archive_command</code>) has not been able to deliver to Barman.</p>
<p>As of Barman 2.10, the <code>get-wal</code> command is able to return the content of the current <code>.partial</code> WAL file through the <code>--partial/-P</code> option. This is particularly useful in the case of recovery, both full or to a point in time. Therefore, in case you run a <code>recover</code> command with <code>get-wal</code> enabled, and without <code>--standby-mode</code>, Barman will automatically add the <code>-P</code> option to <code>barman-wal-restore</code> (which will then relay that to the remote <code>get-wal</code> command) in the <code>restore_command</code> recovery option.</p>
<p><code>get-wal</code> will also search in the <code>incoming</code> directory, in case a WAL file has already been shipped to Barman, but not yet archived.</p>
<h2 id="wal-archiving-via-archive_command">WAL archiving via <code>archive_command</code></h2>
<p>The <code>archive_command</code> is the traditional method to archive WAL files.</p>
<p>The value of this PostgreSQL configuration parameter must be a shell command to be executed by the PostgreSQL server to copy the WAL files to the Barman incoming directory.</p>
<p>This can be done in two ways, both requiring a SSH connection:</p>
<ul>
<li>via <code>barman-wal-archive</code> utility (from Barman 2.6)</li>
<li>via rsync/SSH (common approach before Barman 2.6)</li>
</ul>
<p>See sections below for more details.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> Read the &quot;Concurrent Backup and backup from a standby&quot; section for more detailed information on how Barman supports this feature.</p>
</blockquote>
<h3 id="wal-archiving-via-barman-wal-archive">WAL archiving via <code>barman-wal-archive</code></h3>
<p>From Barman 2.6, the <strong>recommended way</strong> to safely and reliably archive WAL files to Barman via <code>archive_command</code> is to use the <code>barman-wal-archive</code> command contained in the <code>barman-cli</code> package, distributed via EnterpriseDB public repositories and available under GNU GPL 3 licence. <code>barman-cli</code> must be installed on each PostgreSQL server that is part of the Barman cluster.</p>
<p>Using <code>barman-wal-archive</code> instead of rsync/SSH reduces the risk of data corruption of the shipped WAL file on the Barman server. When using rsync/SSH as <code>archive_command</code> a WAL file, there is no mechanism that guarantees that the content of the file is flushed and fsync-ed to disk on destination.</p>
<p>For this reason, we have developed the <code>barman-wal-archive</code> utility that natively communicates with Barman's <code>put-wal</code> command (introduced in 2.6), which is responsible to receive the file, fsync its content and place it in the proper <code>incoming</code> directory for that server. Therefore, <code>barman-wal-archive</code> reduces the risk of copying a WAL file in the wrong location/directory in Barman, as the only parameter to be used in the <code>archive_command</code> is the server's ID.</p>
<p>For more information on the <code>barman-wal-archive</code> command, type <code>man barman-wal-archive</code> on the PostgreSQL server.</p>
<p>You can check that <code>barman-wal-archive</code> can connect to the Barman server, and that the required PostgreSQL server is configured in Barman to accept incoming WAL files with the following command:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb38-1" data-line-number="1"><span class="ex">barman-wal-archive</span> --test backup pg DUMMY</a></code></pre></div>
<p>Where <code>backup</code> is the host where Barman is installed, <code>pg</code> is the name of the PostgreSQL server as configured in Barman and DUMMY is a placeholder (<code>barman-wal-archive</code> requires an argument for the WAL file name, which is ignored).</p>
<p>If everything is configured correctly you should see the following output:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb39-1" data-line-number="1"><span class="ex">Ready</span> to accept WAL files for the server pg</a></code></pre></div>
<p>Since it uses SSH to communicate with the Barman server, SSH key authentication is required for the <code>postgres</code> user to login as <code>barman</code> on the backup server. If a port other than the SSH default of 22 should be used then the <code>--port</code> option can be added to specify the port that should be used for the SSH connection.</p>
<p>Edit the <code>postgresql.conf</code> file of the PostgreSQL instance on the <code>pg</code> database, activate the archive mode and set <code>archive_command</code> to use <code>barman-wal-archive</code>:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb40-1" data-line-number="1"><span class="dt">archive_mode </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></a>
<a class="sourceLine" id="cb40-2" data-line-number="2"><span class="dt">wal_level </span><span class="ot">=</span><span class="st"> &#39;replica&#39;</span></a>
<a class="sourceLine" id="cb40-3" data-line-number="3"><span class="dt">archive_command </span><span class="ot">=</span><span class="st"> &#39;barman-wal-archive backup pg %p&#39;</span></a></code></pre></div>
<p>Then restart the PostgreSQL server.</p>
<h3 id="wal-archiving-via-rsyncssh">WAL archiving via rsync/SSH</h3>
<p>You can retrieve the incoming WALs directory using the <code>show-servers</code> Barman command and looking for the <code>incoming_wals_directory</code> value:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb41-1" data-line-number="1"><span class="ex">barman@backup</span>$ barman show-servers pg <span class="kw">|</span><span class="fu">grep</span> incoming_wals_directory</a>
<a class="sourceLine" id="cb41-2" data-line-number="2">        <span class="ex">incoming_wals_directory</span>: /var/lib/barman/pg/incoming</a></code></pre></div>
<p>Edit the <code>postgresql.conf</code> file of the PostgreSQL instance on the <code>pg</code> database and activate the archive mode:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb42-1" data-line-number="1"><span class="dt">archive_mode </span><span class="ot">=</span><span class="st"> </span><span class="kw">on</span></a>
<a class="sourceLine" id="cb42-2" data-line-number="2"><span class="dt">wal_level </span><span class="ot">=</span><span class="st"> &#39;replica&#39;</span></a>
<a class="sourceLine" id="cb42-3" data-line-number="3"><span class="dt">archive_command </span><span class="ot">=</span><span class="st"> &#39;rsync -a %p barman@backup:INCOMING_WALS_DIRECTORY/%f&#39;</span></a></code></pre></div>
<p>Make sure you change the <code>INCOMING_WALS_DIRECTORY</code> placeholder with the value returned by the <code>barman show-servers pg</code> command above.</p>
<p>Restart the PostgreSQL server.</p>
<p>In some cases, you might want to add stricter checks to the <code>archive_command</code> process. For example, some users have suggested the following one:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb43-1" data-line-number="1"><span class="dt">archive_command </span><span class="ot">=</span><span class="st"> &#39;test $(/bin/hostname --fqdn) = HOSTNAME \</span></a>
<a class="sourceLine" id="cb43-2" data-line-number="2"><span class="dt">  &amp;&amp; rsync -a %p barman@backup:INCOMING_WALS_DIRECTORY/%f&#39;</span></a></code></pre></div>
<p>Where the <code>HOSTNAME</code> placeholder should be replaced with the value returned by <code>hostname --fqdn</code>. This <em>trick</em> is a safeguard in case the server is cloned and avoids receiving WAL files from recovered PostgreSQL instances.</p>
<h2 id="verification-of-wal-archiving-configuration">Verification of WAL archiving configuration</h2>
<p>In order to test that continuous archiving is on and properly working, you need to check both the PostgreSQL server and the backup server. In particular, you need to check that WAL files are correctly collected in the destination directory.</p>
<p>For this purpose and to facilitate the verification of the WAL archiving process, the <code>switch-wal</code> command has been developed:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb44-1" data-line-number="1"><span class="ex">barman@backup</span>$ barman switch-wal --force --archive pg</a></code></pre></div>
<p>The above command will force PostgreSQL to switch WAL file and trigger the archiving process in Barman. Barman will wait for one file to arrive within 30 seconds (you can change the timeout through the <code>--archive-timeout</code> option). If no WAL file is received, an error is returned.</p>
<p>You can verify if the WAL archiving has been correctly configured using the <code>barman check</code> command.</p>
<h2 id="streaming-backup">Streaming backup</h2>
<p>Barman can backup a PostgreSQL server using the streaming connection, relying on <code>pg_basebackup</code>.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> Barman requires that <code>pg_basebackup</code> is installed in the same server. It is recommended to install the last available version of <code>pg_basebackup</code>, as it is backwards compatible. You can even install multiple versions of <code>pg_basebackup</code> on the Barman server and properly point to the specific version for a server, using the <code>path_prefix</code> option in the configuration file.</p>
</blockquote>
<p>To successfully backup your server with the streaming connection, you need to use <code>postgres</code> as your backup method:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb45-1" data-line-number="1"><span class="dt">backup_method </span><span class="ot">=</span><span class="st"> postgres</span></a></code></pre></div>
<blockquote>
<p><strong>IMPORTANT:</strong> You will not be able to start a backup if WAL is not being correctly archived to Barman, either through the <code>archiver</code> or the <code>streaming_archiver</code></p>
</blockquote>
<p>To check if the server configuration is valid you can use the <code>barman check</code> command:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb46-1" data-line-number="1"><span class="ex">barman@backup</span>$ barman check pg</a></code></pre></div>
<p>To start a backup you can use the <code>barman backup</code> command:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb47-1" data-line-number="1"><span class="ex">barman@backup</span>$ barman backup pg</a></code></pre></div>
<h2 id="backup-with-rsyncssh">Backup with <code>rsync</code>/SSH</h2>
<p>The backup over <code>rsync</code> was the only available method before 2.0, and is currently the only backup method that supports the incremental backup feature. Please consult the <em>&quot;Features in detail&quot;</em> section for more information.</p>
<p>To take a backup using <code>rsync</code> you need to put these parameters inside the Barman server configuration file:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb48-1" data-line-number="1"><span class="dt">backup_method </span><span class="ot">=</span><span class="st"> rsync</span></a>
<a class="sourceLine" id="cb48-2" data-line-number="2"><span class="dt">ssh_command </span><span class="ot">=</span><span class="st"> ssh postgres@pg</span></a></code></pre></div>
<p>The <code>backup_method</code> option activates the <code>rsync</code> backup method, and the <code>ssh_command</code> option is needed to correctly create an SSH connection from the Barman server to the PostgreSQL server.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> You will not be able to start a backup if WAL is not being correctly archived to Barman, either through the <code>archiver</code> or the <code>streaming_archiver</code></p>
</blockquote>
<p>To check if the server configuration is valid you can use the <code>barman check</code> command:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb49-1" data-line-number="1"><span class="ex">barman@backup</span>$ barman check pg</a></code></pre></div>
<p>To take a backup use the <code>barman backup</code> command:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb50-1" data-line-number="1"><span class="ex">barman@backup</span>$ barman backup pg</a></code></pre></div>
<h2 id="how-to-setup-a-windows-based-server">How to setup a Windows based server</h2>
<p>You can backup a PostgreSQL server running on Windows using the streaming connection for both WAL archiving and for backups.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> This feature is still experimental because it is not yet part of our continuous integration system.</p>
</blockquote>
<p>Follow every step discussed previously for a streaming connection setup.</p>
<blockquote>
<p><strong>WARNING:</strong>: At this moment, <code>pg_basebackup</code> interoperability from Windows to Linux is still experimental. If you are having issues taking a backup from a Windows server and your PostgreSQL locale is not in English, a possible workaround for the issue is instructing your PostgreSQL to emit messages in English. You can do this by putting the following parameter in your <code>postgresql.conf</code> file:</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb51-1" data-line-number="1"><span class="dt">lc_messages </span><span class="ot">=</span><span class="st"> &#39;English&#39;</span></a></code></pre></div>
<p>This has been reported to fix the issue.</p>
</blockquote>
<p>You can backup your server as usual.</p>
<p>Remote recovery is not supported for Windows servers, so you must recover your cluster locally in the Barman server and then copy all the files on a Windows server or use a folder shared between the PostgreSQL server and the Barman server.</p>
<p>Additionally, make sure that the system user chosen to run PostgreSQL has the permission needed to access the restored data. Basically, it must have full control over the PostgreSQL data directory.</p>

<h1 id="general-commands">General commands</h1>
<p>Barman has many commands and, for the sake of exposition, we can organize them by scope.</p>
<p>The scope of the <strong>general commands</strong> is the entire Barman server, that can backup many PostgreSQL servers. <strong>Server commands</strong>, instead, act only on a specified server. <strong>Backup commands</strong> work on a backup, which is taken from a certain server.</p>
<p>The following list includes the general commands.</p>
<h2 id="cron"><code>cron</code></h2>
<p><code>barman</code> doesn't include a long-running daemon or service file (there's nothing to <code>systemctl start</code>, <code>service start</code>, etc.). Instead, the <code>barman cron</code> subcommand is provided to perform <code>barman</code>'s background &quot;steady-state&quot; backup operations.</p>
<p>You can perform maintenance operations, on both WAL files and backups, using the <code>cron</code> command:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb52-1" data-line-number="1"><span class="ex">barman</span> cron</a></code></pre></div>
<blockquote>
<p><strong>NOTE:</strong> This command should be executed in a <em>cron script</em>. Our recommendation is to schedule <code>barman cron</code> to run every minute. If you installed Barman using the rpm or debian package, a cron entry running on every minute will be created for you.</p>
</blockquote>
<p><code>barman cron</code> executes WAL archiving operations concurrently on a server basis, and this also enforces retention policies on those servers that have:</p>
<ul>
<li><code>retention_policy</code> not empty and valid;</li>
<li><code>retention_policy_mode</code> set to <code>auto</code>.</li>
</ul>
<p>The <code>cron</code> command ensures that WAL streaming is started for those servers that have requested it, by transparently executing the <code>receive-wal</code> command.</p>
<p>In order to stop the operations started by the <code>cron</code> command, comment out the cron entry and execute:</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb53-1" data-line-number="1"><span class="ex">barman</span> receive-wal --stop SERVER_NAME</a></code></pre></div>
<p>You might want to check <code>barman list-servers</code> to make sure you get all of your servers.</p>
<blockquote>
<p><strong>NOTE:</strong> <code>barman cron</code> runs background maintenance tasks only and is not responsible for running scheduled backups. Any regularly scheduled backup jobs you require must be scheduled separately, for example in another cron entry which runs <code>barman backup all</code>.</p>
</blockquote>
<h2 id="diagnose"><code>diagnose</code></h2>
<p>The <code>diagnose</code> command creates a JSON report useful for diagnostic and support purposes. This report contains information for all configured servers.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> Even if the diagnose is written in JSON and that format is thought to be machine readable, its structure is not to be considered part of the interface. Format can change between different Barman versions.</p>
</blockquote>
<h2 id="list-servers"><code>list-servers</code></h2>
<p>You can display the list of active servers that have been configured for your backup system with:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb54-1" data-line-number="1"><span class="ex">barman</span> list-servers</a></code></pre></div>
<p>A machine readable output can be obtained with the <code>--minimal</code> option:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb55-1" data-line-number="1"><span class="ex">barman</span> list-servers --minimal</a></code></pre></div>

<h1 id="server-commands">Server commands</h1>
<p>As we said in the previous section, server commands work directly on a PostgreSQL server or on its area in Barman, and are useful to check its status, perform maintenance operations, take backups, and manage the WAL archive.</p>
<h2 id="archive-wal"><code>archive-wal</code></h2>
<p>The <code>archive-wal</code> command execute maintenance operations on WAL files for a given server. This operations include processing of the WAL files received from the streaming connection or from the <code>archive_command</code> or both.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> The <code>archive-wal</code> command, even if it can be directly invoked, is designed to be started from the <code>cron</code> general command.</p>
</blockquote>
<h2 id="backup"><code>backup</code></h2>
<p>The <code>backup</code> command takes a full backup (<em>base backup</em>) of the given servers. It has several options that let you override the corresponding configuration parameter for the new backup. For more information, consult the manual page.</p>
<p>You can perform a full backup for a given server with:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb56-1" data-line-number="1"><span class="ex">barman</span> backup <span class="op">&lt;</span>server_name<span class="op">&gt;</span></a></code></pre></div>
<blockquote>
<p><strong>TIP:</strong> You can use <code>barman backup all</code> to sequentially backup all your configured servers.</p>
</blockquote>
<blockquote>
<p><strong>TIP:</strong> You can use <code>barman backup &lt;server_1_name&gt; &lt;server_2_name&gt;</code> to sequentially backup both <code>&lt;server_1_name&gt;</code> and <code>&lt;server_2_name&gt;</code> servers.</p>
</blockquote>
<p>Barman 2.10 introduces the <code>-w</code>/<code>--wait</code> option for the <code>backup</code> command. When set, Barman temporarily saves the state of the backup to <code>WAITING_FOR_WALS</code>, then waits for all the required WAL files to be archived before setting the state to <code>DONE</code> and proceeding with post-backup hook scripts. If the <code>--wait-timeout</code> option is provided, Barman will stop waiting for WAL files after the specified number of seconds, and the state will remain in <code>WAITING_FOR_WALS</code>.The <code>cron</code> command will continue to check that missing WAL files are archived, then label the backup as <code>DONE</code>.</p>
<h2 id="check"><code>check</code></h2>
<p>You can check the connection to a given server and the configuration coherence with the <code>check</code> command:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb57-1" data-line-number="1"><span class="ex">barman</span> check <span class="op">&lt;</span>server_name<span class="op">&gt;</span></a></code></pre></div>
<blockquote>
<p><strong>TIP:</strong> You can use <code>barman check all</code> to check all your configured servers.</p>
</blockquote>
<blockquote>
<p><strong>IMPORTANT:</strong> The <code>check</code> command is probably the most critical feature that Barman implements. We recommend to integrate it with your alerting and monitoring infrastructure. The <code>--nagios</code> option allows you to easily create a plugin for Nagios/Icinga.</p>
</blockquote>
<h2 id="generate-manifest"><code>generate-manifest</code></h2>
<p>This command is useful when backup is created remotely and pg_basebackup is not involved and <code>backup_manifest</code> file does not exist in backup. It will generate <code>backup_manifest</code> file from backup_id using backup in barman server. If the file already exist, generation command will abort.</p>
<p>Command example:</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb58-1" data-line-number="1"><span class="ex">barman</span> generate-manifest <span class="op">&lt;</span>server_name<span class="op">&gt;</span> <span class="op">&lt;</span>backup_id<span class="op">&gt;</span></a></code></pre></div>
<p>Either backup_id <span id="backup-id-shortcuts">backup id shortcuts</span> can be used.</p>
<p>This command can also be used as post_backup hook script as follows:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb59-1" data-line-number="1"><span class="va">post_backup_script=</span>barman <span class="ex">generate-manifest</span> <span class="va">${BARMAN_SERVER}</span> <span class="va">${BARMAN_BACKUP_ID}</span></a></code></pre></div>
<h2 id="get-wal"><code>get-wal</code></h2>
<p>Barman allows users to request any <em>xlog</em> file from its WAL archive through the <code>get-wal</code> command:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb60-1" data-line-number="1"><span class="ex">barman</span> get-wal [-o OUTPUT_DIRECTORY][-j<span class="kw">|</span><span class="ex">-x</span>] <span class="op">&lt;</span>server_name<span class="op">&gt;</span> <span class="op">&lt;</span>wal_id<span class="op">&gt;</span></a></code></pre></div>
<p>If the requested WAL file is found in the server archive, the uncompressed content will be returned to <code>STDOUT</code>, unless otherwise specified.</p>
<p>The following options are available for the <code>get-wal</code> command:</p>
<ul>
<li><code>-o</code> allows users to specify a destination directory where Barman will deposit the requested WAL file</li>
<li><code>-j</code> will compress the output using <code>bzip2</code> algorithm</li>
<li><code>-x</code> will compress the output using <code>gzip</code> algorithm</li>
<li><code>-p SIZE</code> peeks from the archive up to WAL files, starting from the requested file</li>
</ul>
<p>It is possible to use <code>get-wal</code> during a recovery operation, transforming the Barman server into a <em>WAL hub</em> for your servers. This can be automatically achieved by adding the <code>get-wal</code> value to the <code>recovery_options</code> global/server configuration option:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb61-1" data-line-number="1"><span class="dt">recovery_options </span><span class="ot">=</span><span class="st"> &#39;get-wal&#39;</span></a></code></pre></div>
<p><code>recovery_options</code> is a global/server option that accepts a list of comma separated values. If the keyword <code>get-wal</code> is present during a recovery operation, Barman will prepare the recovery configuration by setting the <code>restore_command</code> so that <code>barman get-wal</code> is used to fetch the required WAL files. Similarly, one can use the <code>--get-wal</code> option for the <code>recover</code> command at run-time.</p>
<p>If <code>get-wal</code> is set in <code>recovery_options</code> but not required during a recovery operation then the <code>--no-get-wal</code> option can be used with the <code>recover</code> command to disable the <code>get-wal</code> recovery option.</p>
<p>This is an example of a <code>restore_command</code> for a local recovery:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb62-1" data-line-number="1"><span class="dt">restore_command </span><span class="ot">=</span><span class="st"> &#39;sudo -u barman barman get-wal SERVER %f &gt; %p&#39;</span></a></code></pre></div>
<p>Please note that the <code>get-wal</code> command should always be invoked as <code>barman</code> user, and that it requires the correct permission to read the WAL files from the catalog. This is the reason why we are using <code>sudo -u barman</code> in the example.</p>
<p>Setting <code>recovery_options</code> to <code>get-wal</code> for a remote recovery will instead generate a <code>restore_command</code> using the <code>barman-wal-restore</code> script. <code>barman-wal-restore</code> is a more resilient shell script which manages SSH connection errors.</p>
<p>This script has many useful options such as the automatic compression and decompression of the WAL files and the <em>peek</em> feature, which allows you to retrieve the next WAL files while PostgreSQL is applying one of them. It is an excellent way to optimise the bandwidth usage between PostgreSQL and Barman.</p>
<p><code>barman-wal-restore</code> is available in the <code>barman-cli</code> package.</p>
<p>This is an example of a <code>restore_command</code> for a remote recovery:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb63-1" data-line-number="1"><span class="dt">restore_command </span><span class="ot">=</span><span class="st"> &#39;barman-wal-restore -U barman backup SERVER %f %p&#39;</span></a></code></pre></div>
<p>Since it uses SSH to communicate with the Barman server, SSH key authentication is required for the <code>postgres</code> user to login as <code>barman</code> on the backup server. If a port other than the SSH default of 22 should be used then the <code>--port</code> option can be added to specify the port that should be used for the SSH connection.</p>
<p>You can check that <code>barman-wal-restore</code> can connect to the Barman server, and that the required PostgreSQL server is configured in Barman to send WAL files with the following command:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb64-1" data-line-number="1"><span class="ex">barman-wal-restore</span> --test backup pg DUMMY DUMMY</a></code></pre></div>
<p>Where <code>backup</code> is the host where Barman is installed, <code>pg</code> is the name of the PostgreSQL server as configured in Barman and DUMMY is a placeholder (<code>barman-wal-restore</code> requires two argument for the WAL file name and destination directory, which are ignored).</p>
<p>If everything is configured correctly you should see the following output:</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb65-1" data-line-number="1"><span class="ex">Ready</span> to retrieve WAL files from the server pg</a></code></pre></div>
<p>For more information on the <code>barman-wal-restore</code> command, type <code>man barman-wal-restore</code> on the PostgreSQL server.</p>
<h2 id="list-backups"><code>list-backups</code></h2>
<p>You can list the catalog of available backups for a given server with:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb66-1" data-line-number="1"><span class="ex">barman</span> list-backups <span class="op">&lt;</span>server_name<span class="op">&gt;</span></a></code></pre></div>
<blockquote>
<p><strong>TIP:</strong> You can request a full list of the backups of all servers using <code>all</code> as the server name.</p>
</blockquote>
<p>To have a machine-readable output you can use the <code>--minimal</code> option.</p>
<h2 id="rebuild-xlogdb"><code>rebuild-xlogdb</code></h2>
<p>At any time, you can regenerate the content of the WAL archive for a specific server (or every server, using the <code>all</code> shortcut). The WAL archive is contained in the <code>xlog.db</code> file and every server managed by Barman has its own copy.</p>
<p>The <code>xlog.db</code> file can be rebuilt with the <code>rebuild-xlogdb</code> command. This will scan all the archived WAL files and regenerate the metadata for the archive.</p>
<p>For example:</p>
<div class="sourceCode" id="cb67"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb67-1" data-line-number="1"><span class="ex">barman</span> rebuild-xlogdb <span class="op">&lt;</span>server_name<span class="op">&gt;</span></a></code></pre></div>
<h2 id="receive-wal"><code>receive-wal</code></h2>
<p>This command manages the <code>receive-wal</code> process, which uses the streaming protocol to receive WAL files from the PostgreSQL streaming connection.</p>
<h3 id="receive-wal-process-management">receive-wal process management</h3>
<p>If the command is run without options, a <code>receive-wal</code> process will be started. This command is based on the <code>pg_receivewal</code> PostgreSQL command.</p>
<div class="sourceCode" id="cb68"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb68-1" data-line-number="1"><span class="ex">barman</span> receive-wal <span class="op">&lt;</span>server_name<span class="op">&gt;</span></a></code></pre></div>
<blockquote>
<p><strong>NOTE:</strong> The <code>receive-wal</code> command is a foreground process.</p>
</blockquote>
<p>If the command is run with the <code>--stop</code> option, the currently running <code>receive-wal</code> process will be stopped.</p>
<p>The <code>receive-wal</code> process uses a status file to track last written record of the transaction log. When the status file needs to be cleaned, the <code>--reset</code> option can be used.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> If you are not using replication slots, you rely on the value of <code>wal_keep_segments</code> (or <code>wal_keep_size</code> from PostgreSQL version 13.0 onwards). Be aware that under high peaks of workload on the database, the <code>receive-wal</code> process might fall behind and go out of sync. As a precautionary measure, Barman currently requires that users manually execute the command with the <code>--reset</code> option, to avoid making wrong assumptions.</p>
</blockquote>
<h3 id="replication-slot-management">Replication slot management</h3>
<p>The <code>receive-wal</code> process is also useful to create or drop the replication slot needed by Barman for its WAL archiving procedure.</p>
<p>With the <code>--create-slot</code> option, the replication slot named after the <code>slot_name</code> configuration option will be created on the PostgreSQL server.</p>
<p>With the <code>--drop-slot</code>, the previous replication slot will be deleted.</p>
<h2 id="replication-status"><code>replication-status</code></h2>
<p>The <code>replication-status</code> command reports the status of any streaming client currently attached to the PostgreSQL server, including the <code>receive-wal</code> process of your Barman server (if configured).</p>
<p>You can execute the command as follows:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb69-1" data-line-number="1"><span class="ex">barman</span> replication-status <span class="op">&lt;</span>server_name<span class="op">&gt;</span></a></code></pre></div>
<blockquote>
<p><strong>TIP:</strong> You can request a full status report of the replica for all your servers using <code>all</code> as the server name.</p>
</blockquote>
<p>To have a machine-readable output you can use the <code>--minimal</code> option.</p>
<h2 id="show-servers"><code>show-servers</code></h2>
<p>You can show the configuration parameters for a given server with:</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb70-1" data-line-number="1"><span class="ex">barman</span> show-servers <span class="op">&lt;</span>server_name<span class="op">&gt;</span></a></code></pre></div>
<blockquote>
<p><strong>TIP:</strong> you can request a full configuration report using <code>all</code> as the server name.</p>
</blockquote>
<h2 id="status"><code>status</code></h2>
<p>The <code>status</code> command shows live information and status of a PostgreSQL server or of all servers if you use <code>all</code> as server name.</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb71-1" data-line-number="1"><span class="ex">barman</span> status <span class="op">&lt;</span>server_name<span class="op">&gt;</span></a></code></pre></div>
<h2 id="switch-wal"><code>switch-wal</code></h2>
<p>This command makes the PostgreSQL server switch to another transaction log file (WAL), allowing the current log file to be closed, received and then archived.</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb72-1" data-line-number="1"><span class="ex">barman</span> switch-wal <span class="op">&lt;</span>server_name<span class="op">&gt;</span></a></code></pre></div>
<p>If there has been no transaction activity since the last transaction log file switch, the switch needs to be forced using the <code>--force</code> option.</p>
<p>The <code>--archive</code> option requests Barman to trigger WAL archiving after the xlog switch. By default, a 30 seconds timeout is enforced (this can be changed with <code>--archive-timeout</code>). If no WAL file is received, an error is returned.</p>
<blockquote>
<p><strong>NOTE:</strong> In Barman 2.1 and 2.2 this command was called <code>switch-xlog</code>. It has been renamed for naming consistency with PostgreSQL 10 and higher.</p>
</blockquote>
<h2 id="verify"><code>verify</code></h2>
<p>The <code>verify</code> command uses backup_manifest file from backup and runs <code>pg_verifybackup</code> against it.</p>
<div class="sourceCode" id="cb73"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb73-1" data-line-number="1"><span class="ex">barman</span> verify <span class="op">&lt;</span>server_name<span class="op">&gt;</span> <span class="op">&lt;</span>backup_id<span class="op">&gt;</span></a></code></pre></div>
<p>This command will call <code>pg_verifybackup &lt;path_to_backup_manifest&gt; -n</code> (available on PG&gt;=13) <code>pg_verifybackup</code> Must be installed on backup server. For rsync backups, it can be used with <code>generate-manifest</code> command.</p>
<p>Either backup_id <span id="backup-id-shortcuts">backup id shortcuts</span> can be used.</p>

<h1 id="backup-commands">Backup commands</h1>
<p>Backup commands are those that works directly on backups already existing in Barman's backup catalog.</p>
<blockquote>
<p><strong>NOTE:</strong> Remember a backup ID can be retrieved with <code>barman list-backups &lt;server_name&gt;</code></p>
</blockquote>
<h2 id="backup-id-shortcuts">Backup ID shortcuts</h2>
<p>Barman allows you to use special keywords to identify a specific backup:</p>
<ul>
<li><code>last/latest</code>: identifies the newest backup in the catalog</li>
<li><code>first/oldest</code>: identifies the oldest backup in the catalog</li>
<li><code>last-failed</code>: identifies the newest failed backup in the catalog</li>
</ul>
<p>Using those keywords with Barman commands allows you to execute actions without knowing the exact ID of a backup for a server. For example we can issue:</p>
<div class="sourceCode" id="cb74"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb74-1" data-line-number="1"><span class="ex">barman</span> delete <span class="op">&lt;</span>server_name<span class="op">&gt;</span> oldest</a></code></pre></div>
<p>to remove the oldest backup available in the catalog and reclaim disk space.</p>
<p>Additionally, if backup was taken with the <code>--name &lt;friendly_name&gt;</code> option, you can use the friendly name in place of the backup ID to refer to that specific backup.</p>
<h2 id="check-backup"><code>check-backup</code></h2>
<p>Starting with version 2.5, you can check that all required WAL files for the consistency of a full backup have been correctly archived by <code>barman</code> with the <code>check-backup</code> command:</p>
<div class="sourceCode" id="cb75"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb75-1" data-line-number="1"><span class="ex">barman</span> check-backup <span class="op">&lt;</span>server_name<span class="op">&gt;</span> <span class="op">&lt;</span>backup_id<span class="op">&gt;</span></a></code></pre></div>
<blockquote>
<p><strong>IMPORTANT:</strong> This command is automatically invoked by <code>cron</code> and at the end of a <code>backup</code> operation. This means that, under normal circumstances, you should never need to execute it.</p>
</blockquote>
<p>In case one or more WAL files from the start to the end of the backup have not been archived yet, <code>barman</code> will label the backup as <code>WAITING_FOR_WALS</code>. The <code>cron</code> command will continue to check that missing WAL files are archived, then label the backup as <code>DONE</code>.</p>
<p>In case the first required WAL file is missing at the end of the backup, such backup will be marked as <code>FAILED</code>. It is therefore important that you verify that WAL archiving (whether via streaming or <code>archive_command</code>) is properly working before executing a backup operation - especially when backing up from a standby server.</p>
<h2 id="delete"><code>delete</code></h2>
<p>You can delete a given backup with:</p>
<div class="sourceCode" id="cb76"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb76-1" data-line-number="1"><span class="ex">barman</span> delete <span class="op">&lt;</span>server_name<span class="op">&gt;</span> <span class="op">&lt;</span>backup_id<span class="op">&gt;</span></a></code></pre></div>
<p>The <code>delete</code> command accepts any <a href="#backup-id-shortcuts">shortcut</a> to identify backups.</p>
<h2 id="keep"><code>keep</code></h2>
<p>If you have a backup which you wish to keep beyond the retention policy of the server then you can make it an archival backup with:</p>
<div class="sourceCode" id="cb77"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb77-1" data-line-number="1"><span class="ex">barman</span> keep <span class="op">&lt;</span>server_name<span class="op">&gt;</span> <span class="op">&lt;</span>backup_id<span class="op">&gt;</span> [--target TARGET, --status, --release]</a></code></pre></div>
<p>Possible values for <code>TARGET</code> are:</p>
<ul>
<li><code>full</code>: The backup can always be used to recover to the latest point in time. To achieve this, Barman will retain all WALs needed to ensure consistency of the backup and all subsequent WALs.</li>
<li><code>standalone</code>: The backup can only be used to recover the server to its state at the time the backup was taken. Barman will only retain the WALs needed to ensure consistency of the backup.</li>
</ul>
<p>If the <code>--status</code> option is provided then Barman will report the archival status of the backup. This will either be the recovery target of <code>full</code> or <code>standalone</code> for archival backups or <code>nokeep</code> for backups which have not been flagged as archival.</p>
<p>If the <code>--release</code> option is provided then Barman will release the keep flag from this backup. This will remove its archival status and make it available for deletion, either directly or by retention policy.</p>
<p>Once a backup has been flagged as an archival backup, the behaviour of Barman will change as follows:</p>
<ul>
<li>Attempts to delete that backup by ID using <code>barman delete</code> will fail.</li>
<li>Retention policies will never consider that backup as <code>OBSOLETE</code> and therefore <code>barman cron</code> will never delete that backup.</li>
<li>The WALs required by that backup will be retained forever. If the specified recovery target is <code>full</code> then <em>all</em> subsequent WALs will also be retained.</li>
</ul>
<p>This can be reverted by removing the keep flag with <code>barman keep &lt;server_name&gt; &lt;backup_id&gt; --release</code>.</p>
<blockquote>
<p><strong>WARNING:</strong> Once a <code>standalone</code> archival backup is not required by the retention policy of a server <code>barman cron</code> will remove the WALs between that backup and the begin_wal value of the next most recent backup. This means that while it is safe to change the target from <code>full</code> to <code>standalone</code>, it is <em>not</em> safe to change the target from <code>standalone</code> to <code>full</code> because there is no guarantee the necessary WALs for a recovery to the latest point in time will still be available.</p>
</blockquote>
<h2 id="list-files"><code>list-files</code></h2>
<p>You can list the files (base backup and required WAL files) for a given backup with:</p>
<div class="sourceCode" id="cb78"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb78-1" data-line-number="1"><span class="ex">barman</span> list-files [--target TARGET_TYPE] <span class="op">&lt;</span>server_name<span class="op">&gt;</span> <span class="op">&lt;</span>backup_id<span class="op">&gt;</span></a></code></pre></div>
<p>With the <code>--target TARGET_TYPE</code> option, it is possible to choose the content of the list for a given backup.</p>
<p>Possible values for <code>TARGET_TYPE</code> are:</p>
<ul>
<li><code>data</code>: lists the data files</li>
<li><code>standalone</code>: lists the base backup files, including required WAL files</li>
<li><code>wal</code>: lists all WAL files from the beginning of the base backup to the start of the following one (or until the end of the log)</li>
<li><code>full</code>: same as <code>data</code> + <code>wal</code></li>
</ul>
<p>The default value for <code>TARGET_TYPE</code> is <code>standalone</code>.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> The <code>list-files</code> command facilitates interaction with external tools, and can therefore be extremely useful to integrate Barman into your archiving procedures.</p>
</blockquote>
<h2 id="recover"><code>recover</code></h2>
<p>The <code>recover</code> command is used to recover a whole server after a backup is executed using the <code>backup</code> command.</p>
<p>This is achieved issuing a command like the following:</p>
<div class="sourceCode" id="cb79"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb79-1" data-line-number="1"><span class="ex">barman@backup</span>$ barman recover <span class="op">&lt;</span>server_name<span class="op">&gt;</span> <span class="op">&lt;</span>backup_id<span class="op">&gt;</span> /path/to/recover/dir</a></code></pre></div>
<blockquote>
<p><strong>IMPORTANT:</strong> Do not issue a <code>recover</code> command using a target data directory where a PostgreSQL instance is running. In that case, remember to stop it before issuing the recovery. This applies also to tablespace directories.</p>
</blockquote>
<p>At the end of the execution of the recovery, the selected backup is recovered locally and the destination path contains a data directory ready to be used to start a PostgreSQL instance.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> Running this command as user <code>barman</code>, it will become the database superuser.</p>
</blockquote>
<p>The specific ID of a backup can be retrieved using the <a href="#list-backups">list-backups</a> command.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> Barman does not currently keep track of symbolic links inside PGDATA (except for tablespaces inside pg_tblspc). We encourage system administrators to keep track of symbolic links and to add them to the disaster recovery plans/procedures in case they need to be restored in their original location.</p>
</blockquote>
<p>The recovery command has several options that modify the command behavior.</p>
<h3 id="remote-recovery">Remote recovery</h3>
<p>Add the <code>--remote-ssh-command &lt;COMMAND&gt;</code> option to the invocation of the recovery command. Doing this will allow Barman to execute the copy on a remote server, using the provided command to connect to the remote host.</p>
<blockquote>
<p><strong>NOTE:</strong> It is advisable to use the <code>postgres</code> user to perform the recovery on the remote host.</p>
</blockquote>
<blockquote>
<p><strong>IMPORTANT:</strong> Do not issue a <code>recover</code> command using a target data directory where a PostgreSQL instance is running. In that case, remember to stop it before issuing the recovery. This applies also to tablespace directories.</p>
</blockquote>
<p>Known limitations of the remote recovery are:</p>
<ul>
<li>Barman requires at least 4GB of free space in the system temporary directory unless the <a href="#get-wal"><code>get-wal</code></a> command is specified in the <code>recovery_option</code> parameter in the Barman configuration.</li>
<li>The SSH connection between Barman and the remote host <strong>must</strong> use the public key exchange authentication method</li>
<li>The remote user <strong>must</strong> be able to create the directory structure of the backup in the destination directory.</li>
<li>There must be enough free space on the remote server to contain the base backup and the WAL files needed for recovery.</li>
</ul>
<h3 id="tablespace-remapping">Tablespace remapping</h3>
<p>Barman is able to automatically remap one or more tablespaces using the recover command with the --tablespace option. The option accepts a pair of values as arguments using the <code>NAME:DIRECTORY</code> format:</p>
<ul>
<li><code>NAME</code> is the identifier of the tablespace</li>
<li><code>DIRECTORY</code> is the new destination path for the tablespace</li>
</ul>
<p>If the destination directory does not exists, Barman will try to create it (assuming you have the required permissions).</p>
<h3 id="point-in-time-recovery">Point in time recovery</h3>
<p>Barman wraps PostgreSQL's Point-in-Time Recovery (PITR), allowing you to specify a recovery target, either as a timestamp, as a restore label, or as a transaction ID.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> The earliest PITR for a given backup is the end of the base backup itself. If you want to recover at any point in time between the start and the end of a backup, you must use the previous backup. From Barman 2.3 you can exit recovery when consistency is reached by using <code>--target-immediate</code> option.</p>
</blockquote>
<p>The recovery target can be specified using one of the following mutually exclusive options:</p>
<ul>
<li><code>--target-time TARGET_TIME</code>: to specify a timestamp</li>
<li><code>--target-xid TARGET_XID</code>: to specify a transaction ID</li>
<li><code>--target-lsn TARGET_LSN</code>: to specify a Log Sequence Number (LSN) - requires PostgreSQL 10 or higher</li>
<li><code>--target-name TARGET_NAME</code>: to specify a named restore point previously created with the pg_create_restore_point(name) function</li>
<li><code>--target-immediate</code>: recovery ends when a consistent state is reached (that is the end of the base backup process)</li>
</ul>
<blockquote>
<p><strong>IMPORTANT:</strong> Recovery target via <em>time</em>, <em>XID</em> and LSN <strong>must be</strong> subsequent to the end of the backup. If you want to recover to a point in time between the start and the end of a backup, you must recover from the previous backup in the catalogue.</p>
</blockquote>
<p>You can use the <code>--exclusive</code> option to specify whether to stop immediately before or immediately after the recovery target.</p>
<p>Barman allows you to specify a target timeline for recovery using the <code>--target-tli</code> option. This can be set to a numeric timeline ID or one of the special values <code>latest</code> (to recover to the most recent timeline in the WAL archive) and <code>current</code> (to recover to the timeline which was current when the backup was taken). If this option is omitted then PostgreSQL versions 12 and above will recover to the <code>latest</code> timeline and PostgreSQL versions below 12 will recover to the <code>current</code> timeline. You can find more details about timelines in the PostgreSQL documentation as mentioned in the <em>&quot;Before you start&quot;</em> section.</p>
<p>Barman 2.4 introduces support for <code>--target-action</code> option, accepting the following values:</p>
<ul>
<li><code>shutdown</code>: once recovery target is reached, PostgreSQL is shut down</li>
<li><code>pause</code>: once recovery target is reached, PostgreSQL is started in pause state, allowing users to inspect the instance</li>
<li><code>promote</code>: once recovery target is reached, PostgreSQL will exit recovery and is promoted as a master</li>
</ul>
<blockquote>
<p><strong>IMPORTANT:</strong> By default, no target action is defined (for back compatibility). The <code>--target-action</code> option requires a Point In Time Recovery target to be specified.</p>
</blockquote>
<p>For more detailed information on the above settings, please consult the <a href="https://www.postgresql.org/docs/current/static/runtime-config-wal.html#RUNTIME-CONFIG-WAL-RECOVERY-TARGET">PostgreSQL documentation on recovery target settings</a>.</p>
<p>Barman 2.4 also adds the <code>--standby-mode</code> option for the <code>recover</code> command which, if specified, properly configures the recovered instance as a standby by creating a <code>standby.signal</code> file (from PostgreSQL 12) or by adding <code>standby_mode = on</code> to the generated recovery configuration. Further information on <em>standby mode</em> is available in the PostgreSQL documentation.</p>
<h3 id="fetching-wals-from-the-barman-server">Fetching WALs from the Barman server</h3>
<p>The <code>barman recover</code> command can optionally configure PostgreSQL to fetch WALs from Barman during recovery. This is enabled by setting the <code>recovery_options</code> global/server configuration option to <code>'get-wal'</code> as described in the <a href="#get-wal">get-wal section</a>. If <code>recovery_options</code> is not set or is empty then Barman will instead copy the WALs required for recovery while executing the <code>barman recover</code> command.</p>
<p>The <code>--get-wal</code> and <code>--no-get-wal</code> options can be used to override the behaviour defined by <code>recovery_options</code>. Use <code>--get-wal</code> with <code>barman recover</code> to enable the fetching of WALs from the Barman server, alternatively use <code>--no-get-wal</code> to disable it.</p>
<h3 id="recovering-compressed-backups">Recovering compressed backups</h3>
<p>If a backup has been compressed using the <code>backup_compression</code> option then <code>barman recover</code> is able to uncompress the backup on recovery. This is a multi-step process:</p>
<ol type="1">
<li>The compressed backup files are copied to a staging directory on the local or remote server using Rsync.</li>
<li>The compressed files are uncompressed to the target directory.</li>
<li>Config files which need special handling by Barman are copied from the recovery destination, analysed or edited as required, and copied back to the recovery destination using Rsync.</li>
<li>The staging directory for the backup is removed.</li>
</ol>
<p>Because barman does not know anything about the environment in which it will be deployed it relies on the <code>recovery_staging_path</code> option in order to choose a suitable location for the staging directory.</p>
<p>If you are using the <code>backup_compression</code> option you <em>must</em> therefore either set <code>recovery_staging_path</code> in the global/server config <em>or</em> use the <code>--recovery-staging-path</code> option with the <code>barman recover</code> command. If you do neither of these things and attempt to recover a compressed backup then Barman will fail rather than try to guess a suitable location.</p>
<h2 id="show-backup"><code>show-backup</code></h2>
<p>You can retrieve all the available information for a particular backup of a given server with:</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb80-1" data-line-number="1"><span class="ex">barman</span> show-backup <span class="op">&lt;</span>server_name<span class="op">&gt;</span> <span class="op">&lt;</span>backup_id<span class="op">&gt;</span></a></code></pre></div>
<p>The <code>show-backup</code> command accepts any <a href="#backup-id-shortcuts">shortcut</a> to identify backups.</p>

<h1 id="features-in-detail">Features in detail</h1>
<p>In this section we present several Barman features and discuss their applicability and the configuration required to use them.</p>
<p>This list is not exhaustive, as many scenarios can be created working on the Barman configuration. Nevertheless, it is useful to discuss common patterns.</p>
<h2 id="backup-features">Backup features</h2>
<h3 id="incremental-backup">Incremental backup</h3>
<p>Barman implements <strong>file-level incremental backup</strong>. Incremental backup is a type of full periodic backup which only saves data changes from the latest full backup available in the catalog for a specific PostgreSQL server. It must not be confused with differential backup, which is implemented by <em>WAL continuous archiving</em>.</p>
<blockquote>
<p><strong>NOTE:</strong> Block level incremental backup will be available in future versions.</p>
</blockquote>
<blockquote>
<p><strong>IMPORTANT:</strong> The <code>reuse_backup</code> option can't be used with the <code>postgres</code> backup method at this time.</p>
</blockquote>
<p>The main goals of incremental backups in Barman are:</p>
<ul>
<li>Reduce the time taken for the full backup process</li>
<li>Reduce the disk space occupied by several periodic backups (<strong>data deduplication</strong>)</li>
</ul>
<p>This feature heavily relies on <code>rsync</code> and <a href="https://en.wikipedia.org/wiki/Hard_link">hard links</a>, which must therefore be supported by both the underlying operating system and the file system where the backup data resides.</p>
<p>The main concept is that a subsequent base backup will share those files that have not changed since the previous backup, leading to relevant savings in disk usage. This is particularly true of VLDB contexts and of those databases containing a high percentage of <em>read-only historical tables</em>.</p>
<p>Barman implements incremental backup through a global/server option called <code>reuse_backup</code>, that transparently manages the <code>barman backup</code> command. It accepts three values:</p>
<ul>
<li><code>off</code>: standard full backup (default)</li>
<li><code>link</code>: incremental backup, by reusing the last backup for a server and creating a hard link of the unchanged files (for backup space and time reduction)</li>
<li><code>copy</code>: incremental backup, by reusing the last backup for a server and creating a copy of the unchanged files (just for backup time reduction)</li>
</ul>
<p>The most common scenario is to set <code>reuse_backup</code> to <code>link</code>, as follows:</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb81-1" data-line-number="1"><span class="dt">reuse_backup </span><span class="ot">=</span><span class="st"> link</span></a></code></pre></div>
<p>Setting this at global level will automatically enable incremental backup for all your servers.</p>
<p>As a final note, users can override the setting of the <code>reuse_backup</code> option through the <code>--reuse-backup</code> runtime option for the <code>barman backup</code> command. Similarly, the runtime option accepts three values: <code>off</code>, <code>link</code> and <code>copy</code>. For example, you can run a one-off incremental backup as follows:</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb82-1" data-line-number="1"><span class="ex">barman</span> backup --reuse-backup=link <span class="op">&lt;</span>server_name<span class="op">&gt;</span></a></code></pre></div>
<h3 id="limiting-bandwidth-usage">Limiting bandwidth usage</h3>
<p>It is possible to limit the usage of I/O bandwidth through the <code>bandwidth_limit</code> option (global/per server), by specifying the maximum number of kilobytes per second. By default it is set to 0, meaning no limit.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> the <code>bandwidth_limit</code> option is supported with the <code>postgres</code> backup method, but the <code>tablespace_bandwidth_limit</code> option is available only if you use <code>rsync</code>.</p>
</blockquote>
<p>In case you have several tablespaces and you prefer to limit the I/O workload of your backup procedures on one or more tablespaces, you can use the <code>tablespace_bandwidth_limit</code> option (global/per server):</p>
<div class="sourceCode" id="cb83"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb83-1" data-line-number="1"><span class="dt">tablespace_bandwidth_limit </span><span class="ot">=</span><span class="st"> tbname:bwlimit[, tbname:bwlimit, ...]</span></a></code></pre></div>
<p>The option accepts a comma separated list of pairs made up of the tablespace name and the bandwidth limit (in kilobytes per second).</p>
<p>When backing up a server, Barman will try and locate any existing tablespace in the above option. If found, the specified bandwidth limit will be enforced. If not, the default bandwidth limit for that server will be applied.</p>
<h3 id="network-compression">Network Compression</h3>
<p>It is possible to reduce the size of transferred data using compression. It can be enabled using the <code>network_compression</code> option (global/per server):</p>
<blockquote>
<p><strong>IMPORTANT:</strong> the <code>network_compression</code> option is not available with the <code>postgres</code> backup method.</p>
</blockquote>
<div class="sourceCode" id="cb84"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb84-1" data-line-number="1"><span class="dt">network_compression </span><span class="ot">=</span><span class="st"> </span><span class="kw">true</span><span class="st">|</span><span class="kw">false</span></a></code></pre></div>
<p>Setting this option to <code>true</code> will enable data compression during network transfers (for both backup and recovery). By default it is set to <code>false</code>.</p>
<h3 id="backup-compression">Backup Compression</h3>
<p>Barman can use the compression features of pg_basebackup in order to compress the backup data during the backup process. This can be enabled using the <code>backup_compression</code> config option (global/per server):</p>
<blockquote>
<p><strong>IMPORTANT:</strong> the <code>backup_compression</code> and other options discussed in this section are not available with the <code>rsync</code> or <code>local-rsync</code> backup methods. Only with <code>postgres</code> backup method.</p>
</blockquote>
<h4 id="compression-algorithms">Compression algorithms</h4>
<p>Setting this option will cause pg_basebackup to compress the backup using the specified compression algorithm. Currently, supported algorithm in Barman are: <code>gzip</code> <code>lz4</code> and <code>zstd</code>.</p>
<div class="sourceCode" id="cb85"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb85-1" data-line-number="1"><span class="dt">backup_compression </span><span class="ot">=</span><span class="st"> gzip|lz4|zstd</span></a></code></pre></div>
<p>Barman requires the CLI utility for the selected compression algorithm to be available on both the Barman server <em>and</em> the PostgreSQL server. The CLI utility is used to extract the backup label from the compressed backup and to decompress the backup on the PostgreSQL server during recovery. These can be installed through system packages named <code>gzip</code>, <code>lz4</code> and <code>zstd</code> on Debian, Ubuntu, RedHat, CentOS and SLES systems.</p>
<blockquote>
<p><strong>Note:</strong> On Ubuntu 18.04 (bionic) the <code>lz4</code> utility is available in the <code>liblz4-tool</code> pacakge.</p>
</blockquote>
<blockquote>
<p><strong>Note:</strong> <code>zstd</code> version must be 1.4.4 or higher. The system packages for <code>zstd</code> on Debian 10 (buster), Ubuntu 18.04 (bionic) and SLES 12 install an earlier version - <code>backup_compression = zstd</code> will not work with these packages.</p>
</blockquote>
<blockquote>
<p><strong>Note:</strong> <code>lz4</code> and <code>zstd</code> are only available with PostgreSQL version 15 or higher.</p>
</blockquote>
<blockquote>
<p><strong>IMPORTANT:</strong> If you are using <code>backup_compression</code> you must also set <code>recovery_staging_path</code> so that <code>barman recover</code> is able to recover the compressed backups. See the <a href="#recovering-compressed-backups">Recovering compressed backups</a> section for more information.</p>
</blockquote>
<h4 id="compression-workers">Compression workers</h4>
<p>This optional parameter allows compression using multiple threads to increase compression speed (default being 0).</p>
<div class="sourceCode" id="cb86"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb86-1" data-line-number="1"><span class="dt">backup_compression_workers </span><span class="ot">=</span><span class="st"> </span><span class="dv">2</span></a></code></pre></div>
<blockquote>
<p><strong>Note:</strong> This option is only available with <code>zstd</code> compression.</p>
</blockquote>
<blockquote>
<p><strong>Note:</strong> <code>zstd</code> version must be 1.5.0 or higher. Or 1.4.4 or higher compiled with multithreading option.</p>
</blockquote>
<h4 id="compression-level">Compression level</h4>
<p>The compression level can be specified using the <code>backup_compression_level</code> option. This should be set to an integer value supported by the compression algorithm specified in <code>backup_compression</code>.</p>
<h4 id="compression-location">Compression location</h4>
<p>When using Barman with PostgreSQL version 15 or higher it is possible to specify for compression to happen on the server (i.e. PostgreSQL will compress the backup) or on the client (i.e. pg_basebackup will compress the backup). This can be achieved using the <code>backup_compression_location</code> option:</p>
<blockquote>
<p><strong>IMPORTANT:</strong> the <code>backup_compression_location</code> option is only available when running against PostgreSQL 15 or later.</p>
</blockquote>
<div class="sourceCode" id="cb87"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb87-1" data-line-number="1"><span class="dt">backup_compression_location </span><span class="ot">=</span><span class="st"> server|client</span></a></code></pre></div>
<p>Using <code>backup_compression_location = server</code> should reduce the network bandwidth required by the backup at the cost of moving the compression work onto the PostgreSQL server.</p>
<p>When <code>backup_compression_location</code> is set to <code>server</code> then an additional option, <code>backup_compression_format</code>, can be set to <code>plain</code> in order to have pg_basebackup uncompress the data before writing it to disk:</p>
<h4 id="compression-format">Compression format</h4>
<div class="sourceCode" id="cb88"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb88-1" data-line-number="1"><span class="dt">backup_compression_format </span><span class="ot">=</span><span class="st"> plain|tar</span></a></code></pre></div>
<p>If <code>backup_compression_format</code> is unset or has the value <code>tar</code> then the backup will be written to disk as compressed tarballs. A description of both the <code>plain</code> and <code>tar</code> formats can be found in the <a href="https://www.postgresql.org/docs/current/app-pgbasebackup.html">pg_basebackup documentation</a>.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> Barman uses external tools to manage compressed backups. Depending on the <code>backup_compression</code> and <code>backup_compression_format</code> You may need to install one or more tools on the Postgres server and the Barman server. The following table will help you choose according to your configuration.</p>
</blockquote>
<table>
<thead>
<tr class="header">
<th style="text-align: center;"><strong>backup_compression</strong></th>
<th style="text-align: center;"><strong>backup_compression_format</strong></th>
<th style="text-align: center;"><strong>Postgres server</strong></th>
<th style="text-align: center;"><strong>Barman server</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: center;">gzip</td>
<td style="text-align: center;">plain</td>
<td style="text-align: center;"><strong>tar</strong></td>
<td style="text-align: center;">None</td>
</tr>
<tr class="even">
<td style="text-align: center;">gzip</td>
<td style="text-align: center;">tar</td>
<td style="text-align: center;"><strong>tar</strong></td>
<td style="text-align: center;"><strong>tar</strong></td>
</tr>
<tr class="odd">
<td style="text-align: center;">lz4</td>
<td style="text-align: center;">plain</td>
<td style="text-align: center;"><strong>tar, lz4</strong></td>
<td style="text-align: center;">None</td>
</tr>
<tr class="even">
<td style="text-align: center;">lz4</td>
<td style="text-align: center;">tar</td>
<td style="text-align: center;"><strong>tar, lz4</strong></td>
<td style="text-align: center;"><strong>tar, lz4</strong></td>
</tr>
<tr class="odd">
<td style="text-align: center;">zstd</td>
<td style="text-align: center;">plain</td>
<td style="text-align: center;"><strong>tar, zstd</strong></td>
<td style="text-align: center;">None</td>
</tr>
<tr class="even">
<td style="text-align: center;">zstd</td>
<td style="text-align: center;">tar</td>
<td style="text-align: center;"><strong>tar, zstd</strong></td>
<td style="text-align: center;"><strong>tar, zstd</strong></td>
</tr>
</tbody>
</table>
<h3 id="concurrent-backup">Concurrent backup</h3>
<p>Normally, during backup operations, Barman uses PostgreSQL native functions <code>pg_start_backup</code> and <code>pg_stop_backup</code> for <em>concurrent backup</em>.<a href="#fn6" class="footnote-ref" id="fnref6"><sup>6</sup></a> This is the recommended way of taking backups for PostgreSQL 9.6 and above (though note the functions have been renamed to <code>pg_backup_start</code> and <code>pg_backup_stop</code> in the PostgreSQL 15 beta).</p>
<p>As well as being the recommended backup approach, concurrent backup also allows the following architecture scenario with Barman: <strong>backup from a standby server</strong>, using <code>rsync</code>.</p>
<p>By default, <code>backup_options</code> is set to <code>concurrent_backup</code>. If exclusive backup is required for PostgreSQL servers older than version 15 then users should set <code>backup_options</code> to <code>exclusive_backup</code>.</p>
<p>When <code>backup_options</code> is set to <code>concurrent_backup</code>, Barman activates the <em>concurrent backup mode</em> for a server and follows these two simple rules:</p>
<ul>
<li><code>ssh_command</code> must point to the destination Postgres server</li>
<li><code>conninfo</code> must point to a database on the destination Postgres database.</li>
</ul>
<blockquote>
<p><strong>IMPORTANT:</strong> In case of a concurrent backup, currently Barman cannot determine whether the closing WAL file of a full backup has actually been shipped - opposite of an exclusive backup where PostgreSQL itself makes sure that the WAL file is correctly archived. Be aware that the full backup cannot be considered consistent until that WAL file has been received and archived by Barman. Barman 2.5 introduces a new state, called <code>WAITING_FOR_WALS</code>, which is managed by the <code>check-backup</code> command (part of the ordinary maintenance job performed by the <code>cron</code> command). From Barman 2.10, you can use the <code>--wait</code> option with <code>barman backup</code> command.</p>
</blockquote>
<h3 id="concurrent-backup-of-a-standby">Concurrent backup of a standby</h3>
<p>If backing up a standby then the following <a href="https://docs.pgbarman.org/barman.5.html#options">configuration options</a> should point to the standby server:</p>
<ul>
<li><code>conninfo</code></li>
<li><code>streaming_conninfo</code> (when using <code>backup_method = postgres</code> or <code>streaming_archiver = on</code>)</li>
<li><code>ssh_command</code> (when using <code>backup_method = rsync</code>)</li>
</ul>
<p>The following config option should point to the primary server:</p>
<ul>
<li><code>primary_conninfo</code></li>
</ul>
<p>Barman will use <code>primary_conninfo</code> to switch to a new WAL on the primary so that the concurrent backup against the standby can complete without having to wait for a WAL switch to occur naturally.</p>
<blockquote>
<p><strong>NOTE:</strong> It is especially important that <code>primary_conninfo</code> is set if the standby is to be backed up when there is little or no write traffic on the primary. If <code>primary_conninfo</code> is not set then the backup will still run however it will wait at the stop backup stage until the current WAL semgent on the primary is newer than the latest WAL required by the backup.</p>
</blockquote>
<p>Barman currently requires that WAL files and backup data come from the same PostgreSQL server. In the case that the standby is promoted to primary the backups and WALs will continue to be valid however you may wish to update the Barman configuration so that it uses the new standby for taking backups and receiving WALs.</p>
<p>WALs can be obtained from the standby using either WAL streaming or WAL archiving. To use WAL streaming follow the instructions in the <a href="#wal-streaming">WAL streaming</a> section.</p>
<p>To use WAL archiving from the standby follow the instructions in the <a href="#wal-archiving-via-archive_command">WAL archiving via archive_command</a> section <em>and additionally</em> set <code>archive_mode = always</code> in the PostgreSQL config on the standby server.</p>
<blockquote>
<p><strong>NOTE:</strong> With PostgreSQL 10 and earlier Barman cannot handle WAL streaming and WAL archiving being enabled at the same time on a standby. You must therefore disable WAL archiving if using WAL streaming and vice versa. This is because it is possible for WALs produced by PostgreSQL 10 and earlier to be logically equivalent but differ at the binary level, causing Barman to fail to detect that two WALs are identical.</p>
</blockquote>
<h3 id="immediate-checkpoint">Immediate checkpoint</h3>
<p>Before starting a backup, Barman requests a checkpoint, which generates additional workload. Normally that checkpoint is throttled according to the settings for workload control on the PostgreSQL server, which means that the backup could be delayed.</p>
<p>This default behaviour can be changed through the <code>immediate_checkpoint</code> configuration global/server option (set to <code>false</code> by default).</p>
<p>If <code>immediate_checkpoint</code> is set to <code>true</code>, PostgreSQL will not try to limit the workload, and the checkpoint will happen at maximum speed, starting the backup as soon as possible.</p>
<p>At any time, you can override the configuration option behaviour, by issuing <code>barman backup</code> with any of these two options:</p>
<ul>
<li><code>--immediate-checkpoint</code>, which forces an immediate checkpoint;</li>
<li><code>--no-immediate-checkpoint</code>, which forces to wait for the checkpoint to happen.</li>
</ul>
<h3 id="local-backup">Local backup</h3>
<blockquote>
<p><strong>DISCLAIMER:</strong> This feature is not recommended for production usage, as Barman and PostgreSQL reside on the same server and are part of the same single point of failure. Some EnterpriseDB customers have requested to add support for local backup to Barman to be used under specific circumstances and, most importantly, under the 24/7 production service delivered by the company. Using this feature currently requires installation from sources, or to customise the environment for the <code>postgres</code> user in terms of permissions as well as logging and cron configurations.</p>
</blockquote>
<p>Under special circumstances, Barman can be installed on the same server where the PostgreSQL instance resides, with backup data stored on a separate volume from PGDATA and, where applicable, tablespaces. Usually, these volumes reside on network storage appliances, with filesystems like NFS.</p>
<p>This architecture is not endorsed by EnterpriseDB. For an enhanced business continuity experience of PostgreSQL, with better results in terms of RPO and RTO, EnterpriseDB still recommends the shared nothing architecture with a remote installation of Barman, capable of acting like a witness server for replication and monitoring purposes.</p>
<p>The only requirement for local backup is that Barman runs with the same user as the PostgreSQL server, which is normally <code>postgres</code>. Given that the Community packages by default install Barman under the <code>barman</code> user, this use case requires manual installation procedures that include:</p>
<ul>
<li>cron configurations</li>
<li>log configurations, including logrotate</li>
</ul>
<p>In order to use local backup for a given server in Barman, you need to set <code>backup_method</code> to <code>local-rsync</code>. The feature is essentially identical to its <code>rsync</code> equivalent, which relies on SSH instead and operates remotely. With <code>local-rsync</code> file system copy is performed issuing <code>rsync</code> commands locally (for this reason it is required that Barman runs with the same user as PostgreSQL).</p>
<p>An excerpt of configuration for local backup for a server named <code>local-pg13</code> is:</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb89-1" data-line-number="1"><span class="kw">[local-pg13]</span></a>
<a class="sourceLine" id="cb89-2" data-line-number="2"><span class="dt">description </span><span class="ot">=</span><span class="st"> &quot;Local PostgreSQL </span><span class="dv">13</span><span class="st">&quot;</span></a>
<a class="sourceLine" id="cb89-3" data-line-number="3"><span class="dt">backup_method </span><span class="ot">=</span><span class="st"> local-rsync</span></a>
<a class="sourceLine" id="cb89-4" data-line-number="4"><span class="dt">...</span></a></code></pre></div>
<h2 id="archiving-features">Archiving features</h2>
<h3 id="wal-compression">WAL compression</h3>
<p>The <code>barman cron</code> command will compress WAL files if the <code>compression</code> option is set in the configuration file. This option allows five values:</p>
<ul>
<li><code>bzip2</code>: for Bzip2 compression (requires the <code>bzip2</code> utility)</li>
<li><code>gzip</code>: for Gzip compression (requires the <code>gzip</code> utility)</li>
<li><code>pybzip2</code>: for Bzip2 compression (uses Python's internal compression module)</li>
<li><code>pygzip</code>: for Gzip compression (uses Python's internal compression module)</li>
<li><code>pigz</code>: for Pigz compression (requires the <code>pigz</code> utility)</li>
<li><code>custom</code>: for custom compression, which requires you to set the following options as well: - <code>custom_compression_filter</code>: a compression filter - <code>custom_decompression_filter</code>: a decompression filter - <code>custom_compression_magic</code>: a hex string to identify a custom compressed wal file</li>
</ul>
<blockquote>
<p><em>NOTE:</em> All methods but <code>pybzip2</code> and <code>pygzip</code> require <code>barman archive-wal</code> to fork a new process.</p>
</blockquote>
<h3 id="synchronous-wal-streaming">Synchronous WAL streaming</h3>
<p>Barman can also reduce the Recovery Point Objective to zero, by collecting the transaction WAL files like a synchronous standby server would.</p>
<p>To configure such a scenario, the Barman server must be configured to archive WALs via the <a href="#postgresql-streaming-connection">streaming connection</a>, and the <code>receive-wal</code> process should figure as a synchronous standby of the PostgreSQL server.</p>
<p>First of all, you need to retrieve the application name of the Barman <code>receive-wal</code> process with the <code>show-servers</code> command:</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb90-1" data-line-number="1"><span class="ex">barman@backup</span>$ barman show-servers pg<span class="kw">|</span><span class="fu">grep</span> streaming_archiver_name</a>
<a class="sourceLine" id="cb90-2" data-line-number="2">    <span class="ex">streaming_archiver_name</span>: barman_receive_wal</a></code></pre></div>
<p>Then the application name should be added to the <code>postgresql.conf</code> file as a synchronous standby:</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb91-1" data-line-number="1"><span class="dt">synchronous_standby_names </span><span class="ot">=</span><span class="st"> &#39;barman_receive_wal&#39;</span></a></code></pre></div>
<blockquote>
<p><strong>IMPORTANT:</strong> this is only an example of configuration, to show you that Barman is eligible to be a synchronous standby node. We are not suggesting to use ONLY Barman. You can read <em><a href="https://www.postgresql.org/docs/current/static/warm-standby.html#SYNCHRONOUS-REPLICATION">&quot;Synchronous Replication&quot;</a></em> from the PostgreSQL documentation for further information on this topic.</p>
</blockquote>
<p>The PostgreSQL server needs to be restarted for the configuration to be reloaded.</p>
<p>If the server has been configured correctly, the <code>replication-status</code> command should show the <code>receive_wal</code> process as a synchronous streaming client:</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb92-1" data-line-number="1">[<span class="ex">root@backup</span> ~]# barman replication-status pg</a>
<a class="sourceLine" id="cb92-2" data-line-number="2"><span class="ex">Status</span> of streaming clients for server <span class="st">&#39;pg&#39;</span>:</a>
<a class="sourceLine" id="cb92-3" data-line-number="3">  <span class="ex">Current</span> xlog location on master: 0/9000098</a>
<a class="sourceLine" id="cb92-4" data-line-number="4">  <span class="ex">Number</span> of streaming clients: 1</a>
<a class="sourceLine" id="cb92-5" data-line-number="5"></a>
<a class="sourceLine" id="cb92-6" data-line-number="6">  <span class="ex">1.</span> <span class="co">#1 Sync WAL streamer</span></a>
<a class="sourceLine" id="cb92-7" data-line-number="7">     <span class="ex">Application</span> name: barman_receive_wal</a>
<a class="sourceLine" id="cb92-8" data-line-number="8">     <span class="ex">Sync</span> stage      : 3/3 Remote write</a>
<a class="sourceLine" id="cb92-9" data-line-number="9">     <span class="ex">Communication</span>   : TCP/IP</a>
<a class="sourceLine" id="cb92-10" data-line-number="10">     <span class="ex">IP</span> Address      : 139.59.135.32 / Port: 58262 / Host: -</a>
<a class="sourceLine" id="cb92-11" data-line-number="11">     <span class="ex">User</span> name       : streaming_barman</a>
<a class="sourceLine" id="cb92-12" data-line-number="12">     <span class="ex">Current</span> state   : streaming (sync)</a>
<a class="sourceLine" id="cb92-13" data-line-number="13">     <span class="ex">Replication</span> slot: barman</a>
<a class="sourceLine" id="cb92-14" data-line-number="14">     <span class="ex">WAL</span> sender PID  : 2501</a>
<a class="sourceLine" id="cb92-15" data-line-number="15">     <span class="ex">Started</span> at      : 2016-09-16 10:33:01.725883+00:00</a>
<a class="sourceLine" id="cb92-16" data-line-number="16">     <span class="ex">Sent</span> location   : 0/9000098 (diff: 0 B)</a>
<a class="sourceLine" id="cb92-17" data-line-number="17">     <span class="ex">Write</span> location  : 0/9000098 (diff: 0 B)</a>
<a class="sourceLine" id="cb92-18" data-line-number="18">     <span class="ex">Flush</span> location  : 0/9000098 (diff: 0 B)</a></code></pre></div>
<h2 id="catalog-management-features">Catalog management features</h2>
<h3 id="minimum-redundancy-safety">Minimum redundancy safety</h3>
<p>You can define the minimum number of periodic backups for a PostgreSQL server, using the global/per server configuration option called <code>minimum_redundancy</code>, by default set to 0.</p>
<p>By setting this value to any number greater than 0, Barman makes sure that at any time you will have at least that number of backups in a server catalog.</p>
<p>This will protect you from accidental <code>barman delete</code> operations.</p>
<blockquote>
<p><strong>IMPORTANT:</strong> Make sure that your retention policy settings do not collide with minimum redundancy requirements. Regularly check Barman's log for messages on this topic.</p>
</blockquote>
<h3 id="retention-policies">Retention policies</h3>
<p>Barman supports <strong>retention policies</strong> for backups.</p>
<p>A backup retention policy is a user-defined policy that determines how long backups and related archive logs (Write Ahead Log segments) need to be retained for recovery procedures.</p>
<p>Based on the user's request, Barman retains the periodic backups required to satisfy the current retention policy and any archived WAL files required for the complete recovery of those backups.</p>
<p>Barman users can define a retention policy in terms of <strong>backup redundancy</strong> (how many periodic backups) or a <strong>recovery window</strong> (how long).</p>
<dl>
<dt>Retention policy based on redundancy</dt>
<dd><p>In a redundancy based retention policy, the user determines how many periodic backups to keep. A redundancy-based retention policy is contrasted with retention policies that use a recovery window.</p>
</dd>
<dt>Retention policy based on recovery window</dt>
<dd><p>A recovery window is one type of Barman backup retention policy, in which the DBA specifies a period of time and Barman ensures retention of backups and/or archived WAL files required for point-in-time recovery to any time during the recovery window. The interval always ends with the current time and extends back in time for the number of days specified by the user. For example, if the retention policy is set for a recovery window of seven days, and the current time is 9:30 AM on Friday, Barman retains the backups required to allow point-in-time recovery back to 9:30 AM on the previous Friday.</p>
</dd>
</dl>
<h4 id="scope">Scope</h4>
<p>Retention policies can be defined for:</p>
<ul>
<li><strong>PostgreSQL periodic base backups</strong>: through the <code>retention_policy</code> configuration option</li>
<li><strong>Archive logs</strong>, for Point-In-Time-Recovery: through the <code>wal_retention_policy</code> configuration option</li>
</ul>
<blockquote>
<p><strong>IMPORTANT:</strong> In a temporal dimension, archive logs must be included in the time window of periodic backups.</p>
</blockquote>
<p>There are two typical use cases here: full or partial point-in-time recovery.</p>
<dl>
<dt>Full point in time recovery scenario:</dt>
<dd><p>Base backups and archive logs share the same retention policy, allowing you to recover at any point in time from the first available backup.</p>
</dd>
<dt>Partial point in time recovery scenario:</dt>
<dd><p>Base backup retention policy is wider than that of archive logs, for example allowing users to keep full, weekly backups of the last 6 months, but archive logs for the last 4 weeks (granting to recover at any point in time starting from the last 4 periodic weekly backups).</p>
</dd>
</dl>
<blockquote>
<p><strong>IMPORTANT:</strong> Currently, Barman implements only the <strong>full point in time recovery</strong> scenario, by constraining the <code>wal_retention_policy</code> option to <code>main</code>.</p>
</blockquote>
<h4 id="how-they-work">How they work</h4>
<p>Retention policies in Barman can be:</p>
<ul>
<li><strong>automated</strong>: enforced by <code>barman cron</code></li>
<li><strong>manual</strong>: Barman simply reports obsolete backups and allows you to delete them</li>
</ul>
<blockquote>
<p><strong>IMPORTANT:</strong> Currently Barman does not implement manual enforcement. This feature will be available in future versions.</p>
</blockquote>
<h4 id="configuration-and-syntax">Configuration and syntax</h4>
<p>Retention policies can be defined through the following configuration options:</p>
<ul>
<li><code>retention_policy</code>: for base backup retention</li>
<li><code>wal_retention_policy</code>: for archive logs retention</li>
<li><code>retention_policy_mode</code>: can only be set to <code>auto</code> (retention policies are automatically enforced by the <code>barman cron</code> command)</li>
</ul>
<p>These configuration options can be defined both at a global level and a server level, allowing users maximum flexibility on a multi-server environment.</p>
<h5 id="syntax-for-retention_policy">Syntax for <code>retention_policy</code></h5>
<p>The general syntax for a base backup retention policy through <code>retention_policy</code> is the following:</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb93-1" data-line-number="1"><span class="dt">retention_policy </span><span class="ot">=</span><span class="st"> {REDUNDANCY value | RECOVERY WINDOW OF value {DAYS | WEEKS | MONTHS}}</span></a></code></pre></div>
<p>Where:</p>
<ul>
<li>syntax is case insensitive</li>
<li><code>value</code> is an integer and is &gt; 0</li>
<li>in case of <strong>redundancy retention policy</strong>: - <code>value</code> must be greater than or equal to the server minimum redundancy level (if that value is not assigned, a warning is generated) - the first valid backup is the value-th backup in a reverse ordered time series</li>
<li>in case of <strong>recovery window policy</strong>: - the point of recoverability is: current time - window - the first valid backup is the first available backup before the point of recoverability; its value in a reverse ordered time series must be greater than or equal to the server minimum redundancy level (if it is not assigned to that value and a warning is generated)</li>
</ul>
<p>By default, <code>retention_policy</code> is empty (no retention enforced).</p>
<h5 id="syntax-for-wal_retention_policy">Syntax for <code>wal_retention_policy</code></h5>
<p>Currently, the only allowed value for <code>wal_retention_policy</code> is the special value <code>main</code>, that maps the retention policy of archive logs to that of base backups.</p>
<h2 id="hook-scripts">Hook scripts</h2>
<p>Barman allows a database administrator to run hook scripts on these two events:</p>
<ul>
<li>before and after a backup</li>
<li>before and after the deletion of a backup</li>
<li>before and after a WAL file is archived</li>
<li>before and after a WAL file is deleted</li>
</ul>
<p>There are two types of hook scripts that Barman can manage:</p>
<ul>
<li>standard hook scripts</li>
<li>retry hook scripts</li>
</ul>
<p>The only difference between these two types of hook scripts is that Barman executes a standard hook script only once, without checking its return code, whereas a retry hook script may be executed more than once, depending on its return code.</p>
<p>Specifically, when executing a retry hook script, Barman checks the return code and retries indefinitely until the script returns either <code>SUCCESS</code> (with standard return code <code>0</code>), or <code>ABORT_CONTINUE</code> (return code <code>62</code>), or <code>ABORT_STOP</code> (return code <code>63</code>). Barman treats any other return code as a transient failure to be retried. Users are given more power: a hook script can control its workflow by specifying whether a failure is transient. Also, in case of a 'pre' hook script, by returning <code>ABORT_STOP</code>, users can request Barman to interrupt the main operation with a failure.</p>
<p>Hook scripts are executed in the following order:</p>
<ol type="1">
<li>The standard 'pre' hook script (if present)</li>
<li>The retry 'pre' hook script (if present)</li>
<li>The actual event (i.e. backup operation, or WAL archiving), if retry 'pre' hook script was not aborted with <code>ABORT_STOP</code></li>
<li>The retry 'post' hook script (if present)</li>
<li>The standard 'post' hook script (if present)</li>
</ol>
<p>The output generated by any hook script is written in the log file of Barman.</p>
<blockquote>
<p><strong>NOTE:</strong> Currently, <code>ABORT_STOP</code> is ignored by retry 'post' hook scripts. In these cases, apart from logging an additional warning, <code>ABORT_STOP</code> will behave like <code>ABORT_CONTINUE</code>.</p>
</blockquote>
<h3 id="backup-scripts">Backup scripts</h3>
<p>These scripts can be configured with the following global configuration options (which can be overridden on a per server basis):</p>
<ul>
<li><code>pre_backup_script</code>: <em>hook script</em> executed <em>before</em> a base backup, only once, with no check on the exit code</li>
<li><code>pre_backup_retry_script</code>: <em>retry hook script</em> executed <em>before</em> a base backup, repeatedly until success or abort</li>
<li><code>post_backup_retry_script</code>: <em>retry hook script</em> executed <em>after</em> a base backup, repeatedly until success or abort</li>
<li><code>post_backup_script</code>: <em>hook script</em> executed <em>after</em> a base backup, only once, with no check on the exit code</li>
</ul>
<p>The script definition is passed to a shell and can return any exit code. Only in case of a <em>retry</em> script, Barman checks the return code (see the <a href="#hook_scripts">hook script section</a>).</p>
<p>The shell environment will contain the following variables:</p>
<ul>
<li><code>BARMAN_BACKUP_DIR</code>: backup destination directory</li>
<li><code>BARMAN_BACKUP_ID</code>: ID of the backup</li>
<li><code>BARMAN_CONFIGURATION</code>: configuration file used by Barman</li>
<li><code>BARMAN_ERROR</code>: error message, if any (only for the <code>post</code> phase)</li>
<li><code>BARMAN_PHASE</code>: phase of the script, either <code>pre</code> or <code>post</code></li>
<li><code>BARMAN_PREVIOUS_ID</code>: ID of the previous backup (if present)</li>
<li><code>BARMAN_RETRY</code>: <code>1</code> if it is a retry script, <code>0</code> if not</li>
<li><code>BARMAN_SERVER</code>: name of the server</li>
<li><code>BARMAN_STATUS</code>: status of the backup</li>
<li><code>BARMAN_VERSION</code>: version of Barman</li>
</ul>
<h3 id="backup-delete-scripts">Backup delete scripts</h3>
<p>Version <strong>2.4</strong> introduces pre and post backup delete scripts.</p>
<p>As previous scripts, backup delete scripts can be configured within global configuration options, and it is possible to override them on a per server basis:</p>
<ul>
<li><code>pre_delete_script</code>: <em>hook script</em> launched <em>before</em> the deletion of a backup, only once, with no check on the exit code</li>
<li><code>pre_delete_retry_script</code>: <em>retry hook script</em> executed <em>before</em> the deletion of a backup, repeatedly until success or abort</li>
<li><code>post_delete_retry_script</code>: <em>retry hook script</em> executed <em>after</em> the deletion of a backup, repeatedly until success or abort</li>
<li><code>post_delete_script</code>: <em>hook script</em> launched <em>after</em> the deletion of a backup, only once, with no check on the exit code</li>
</ul>
<p>The script is executed through a shell and can return any exit code. Only in case of a <em>retry</em> script, Barman checks the return code (see the upper section).</p>
<p>Delete scripts uses the same environmental variables of a backup script, plus:</p>
<ul>
<li><code>BARMAN_NEXT_ID</code>: ID of the next backup (if present)</li>
</ul>
<h3 id="wal-archive-scripts">WAL archive scripts</h3>
<p>Similar to backup scripts, archive scripts can be configured with global configuration options (which can be overridden on a per server basis):</p>
<ul>
<li><code>pre_archive_script</code>: <em>hook script</em> executed <em>before</em> a WAL file is archived by maintenance (usually <code>barman cron</code>), only once, with no check on the exit code</li>
<li><code>pre_archive_retry_script</code>: <em>retry hook script</em> executed <em>before</em> a WAL file is archived by maintenance (usually <code>barman cron</code>), repeatedly until it is successful or aborted</li>
<li><code>post_archive_retry_script</code>: <em>retry hook script</em> executed <em>after</em> a WAL file is archived by maintenance, repeatedly until it is successful or aborted</li>
<li><code>post_archive_script</code>: <em>hook script</em> executed <em>after</em> a WAL file is archived by maintenance, only once, with no check on the exit code</li>
</ul>
<p>The script is executed through a shell and can return any exit code. Only in case of a <em>retry</em> script, Barman checks the return code (see the upper section).</p>
<p>Archive scripts share with backup scripts some environmental variables:</p>
<ul>
<li><code>BARMAN_CONFIGURATION</code>: configuration file used by Barman</li>
<li><code>BARMAN_ERROR</code>: error message, if any (only for the <code>post</code> phase)</li>
<li><code>BARMAN_PHASE</code>: phase of the script, either <code>pre</code> or <code>post</code></li>
<li><code>BARMAN_SERVER</code>: name of the server</li>
</ul>
<p>Following variables are specific to archive scripts:</p>
<ul>
<li><code>BARMAN_SEGMENT</code>: name of the WAL file</li>
<li><code>BARMAN_FILE</code>: full path of the WAL file</li>
<li><code>BARMAN_SIZE</code>: size of the WAL file</li>
<li><code>BARMAN_TIMESTAMP</code>: WAL file timestamp</li>
<li><code>BARMAN_COMPRESSION</code>: type of compression used for the WAL file</li>
</ul>
<h3 id="wal-delete-scripts">WAL delete scripts</h3>
<p>Version <strong>2.4</strong> introduces pre and post WAL delete scripts.</p>
<p>Similarly to the other hook scripts, wal delete scripts can be configured with global configuration options, and is possible to override them on a per server basis:</p>
<ul>
<li><code>pre_wal_delete_script</code>: <em>hook script</em> executed <em>before</em> the deletion of a WAL file</li>
<li><code>pre_wal_delete_retry_script</code>: <em>retry hook script</em> executed <em>before</em> the deletion of a WAL file, repeatedly until it is successful or aborted</li>
<li><code>post_wal_delete_retry_script</code>: <em>retry hook script</em> executed <em>after</em> the deletion of a WAL file, repeatedly until it is successful or aborted</li>
<li><code>post_wal_delete_script</code>: <em>hook script</em> executed <em>after</em> the deletion of a WAL file</li>
</ul>
<p>The script is executed through a shell and can return any exit code. Only in case of a <em>retry</em> script, Barman checks the return code (see the upper section).</p>
<p>WAL delete scripts use the same environmental variables as WAL archive scripts.</p>
<h3 id="recovery-scripts">Recovery scripts</h3>
<p>Version <strong>2.4</strong> introduces pre and post recovery scripts.</p>
<p>As previous scripts, recovery scripts can be configured within global configuration options, and is possible to override them on a per server basis:</p>
<ul>
<li><code>pre_recovery_script</code>: <em>hook script</em> launched <em>before</em> the recovery of a backup, only once, with no check on the exit code</li>
<li><code>pre_recovery_retry_script</code>: <em>retry hook script</em> executed <em>before</em> the recovery of a backup, repeatedly until success or abort</li>
<li><code>post_recovery_retry_script</code>: <em>retry hook script</em> executed <em>after</em> the recovery of a backup, repeatedly until success or abort</li>
<li><code>post_recovery_script</code>: <em>hook script</em> launched <em>after</em> the recovery of a backup, only once, with no check on the exit code</li>
</ul>
<p>The script is executed through a shell and can return any exit code. Only in case of a <em>retry</em> script, Barman checks the return code (see the upper section).</p>
<p>Recovery scripts uses the same environmental variables of a backup script, plus:</p>
<ul>
<li><p><code>BARMAN_DESTINATION_DIRECTORY</code>: the directory where the new instance is recovered</p></li>
<li><p><code>BARMAN_TABLESPACES</code>: tablespace relocation map (JSON, if present)</p></li>
<li><p><code>BARMAN_REMOTE_COMMAND</code>: secure shell command used by the recovery (if present)</p></li>
<li><p><code>BARMAN_RECOVER_OPTIONS</code>: recovery additional options (JSON, if present)</p></li>
</ul>
<h2 id="customization">Customization</h2>
<h3 id="lock-file-directory">Lock file directory</h3>
<p>Barman allows you to specify a directory for lock files through the <code>barman_lock_directory</code> global option.</p>
<p>Lock files are used to coordinate concurrent work at global and server level (for example, cron operations, backup operations, access to the WAL archive, and so on.).</p>
<p>By default (for backward compatibility reasons), <code>barman_lock_directory</code> is set to <code>barman_home</code>.</p>
<blockquote>
<p><strong>TIP:</strong> Users are encouraged to use a directory in a volatile partition, such as the one dedicated to run-time variable data (e.g. <code>/var/run/barman</code>).</p>
</blockquote>
<h3 id="binary-paths">Binary paths</h3>
<p>As of version 1.6.0, Barman allows users to specify one or more directories where Barman looks for executable files, using the global/server option <code>path_prefix</code>.</p>
<p>If a <code>path_prefix</code> is provided, it must contain a list of one or more directories separated by colon. Barman will search inside these directories first, then in those specified by the <code>PATH</code> environment variable.</p>
<p>By default the <code>path_prefix</code> option is empty.</p>
<h2 id="integration-with-cluster-management-systems">Integration with cluster management systems</h2>
<p>Barman has been designed for integration with standby servers (with streaming replication or traditional file based log shipping) and high availability tools like <a href="https://www.repmgr.org/">repmgr</a>.</p>
<p>From an architectural point of view, PostgreSQL must be configured to archive WAL files directly to the Barman server. Barman, thanks to the <code>get-wal</code> framework, can also be used as a WAL hub. For this purpose, you can use the <code>barman-wal-restore</code> script, part of the <code>barman-cli</code> package, with all your standby servers.</p>
<p>The <code>replication-status</code> command allows you to get information about any streaming client attached to the managed server, in particular hot standby servers and WAL streamers.</p>
<h2 id="parallel-jobs">Parallel jobs</h2>
<p>By default, Barman uses only one worker for file copy during both backup and recover operations. Starting from version 2.2, it is possible to customize the number of workers that will perform file copy. In this case, the files to be copied will be equally distributed among all parallel workers.</p>
<p>It can be configured in global and server scopes, adding these in the corresponding configuration file:</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb94-1" data-line-number="1"><span class="dt">parallel_jobs </span><span class="ot">=</span><span class="st"> n</span></a></code></pre></div>
<p>where <code>n</code> is the desired number of parallel workers to be used in file copy operations. The default value is 1.</p>
<p>In any case, users can override this value at run-time when executing <code>backup</code> or <code>recover</code> commands. For example, you can use 4 parallel workers as follows:</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb95-1" data-line-number="1"><span class="ex">barman</span> backup --jobs 4 server1</a></code></pre></div>
<p>Or, alternatively:</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb96-1" data-line-number="1"><span class="ex">barman</span> backup --j 4 server1</a></code></pre></div>
<p>Please note that this parallel jobs feature is only available for servers configured through <code>rsync</code>/SSH. For servers configured through streaming protocol, Barman will rely on <code>pg_basebackup</code> which is currently limited to only one worker.</p>
<h2 id="geographical-redundancy">Geographical redundancy</h2>
<p>It is possible to set up <strong>cascading backup architectures</strong> with Barman, where the source of a backup server is a Barman installation rather than a PostgreSQL server.</p>
<p>This feature allows users to transparently keep <em>geographically distributed</em> copies of PostgreSQL backups.</p>
<p>In Barman jargon, a backup server that is connected to a Barman installation rather than a PostgreSQL server is defined <strong>passive node</strong>. A passive node is configured through the <code>primary_ssh_command</code> option, available both at global (for a full replica of a primary Barman installation) and server level (for mixed scenarios, having both <em>direct</em> and <em>passive</em> servers).</p>
<h3 id="sync-information">Sync information</h3>
<p>The <code>barman sync-info</code> command is used to collect information regarding the current status of a Barman server that is useful for synchronisation purposes. The available syntax is the following:</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb97-1" data-line-number="1"><span class="ex">barman</span> sync-info [--primary] <span class="op">&lt;</span>server_name<span class="op">&gt;</span> [<span class="op">&lt;</span>last_wal<span class="op">&gt;</span> [<span class="op">&lt;</span>last_position<span class="op">&gt;</span>]]</a></code></pre></div>
<p>The command returns a JSON object containing:</p>
<ul>
<li>A map with all the backups having status <code>DONE</code> for that server</li>
<li>A list with all the archived WAL files</li>
<li>The configuration for the server</li>
<li>The last read position (in the <em>xlog database file</em>)</li>
<li>the name of the last read WAL file</li>
</ul>
<p>The JSON response contains all the required information for the synchronisation between the <code>master</code> and a <code>passive</code> node.</p>
<p>If <code>--primary</code> is specified, the command is executed on the defined primary node, rather than locally.</p>
<h3 id="configuration-1">Configuration</h3>
<p>Configuring a server as <code>passive node</code> is a quick operation. Simply add to the server configuration the following option:</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb98-1" data-line-number="1"><span class="dt">primary_ssh_command </span><span class="ot">=</span><span class="st"> ssh barman@primary_barman</span></a></code></pre></div>
<p>This option specifies the SSH connection parameters to the primary server, identifying the source of the backup data for the passive server.</p>
<p>If you are invoking barman with the <code>-c/--config</code> option and you want to use the same option when the passive node invokes barman on the primary node then add the following option:</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode ini"><code class="sourceCode ini"><a class="sourceLine" id="cb99-1" data-line-number="1"><span class="dt">forward_config_path </span><span class="ot">=</span><span class="st"> </span><span class="kw">true</span></a></code></pre></div>
<h3 id="node-synchronisation">Node synchronisation</h3>
<p>When a node is marked as <code>passive</code> it is treated in a special way by Barman:</p>
<ul>
<li>it is excluded from standard maintenance operations</li>
<li>direct operations to PostgreSQL are forbidden, including <code>barman backup</code></li>
</ul>
<p>Synchronisation between a passive server and its primary is automatically managed by <code>barman cron</code> which will transparently invoke:</p>
<ol type="1">
<li><code>barman sync-info --primary</code>, in order to collect synchronisation information</li>
<li><code>barman sync-backup</code>, in order to create a local copy of every backup that is available on the primary node</li>
<li><code>barman sync-wals</code>, in order to copy locally all the WAL files available on the primary node</li>
</ol>
<h3 id="manual-synchronisation">Manual synchronisation</h3>
<p>Although <code>barman cron</code> automatically manages passive/primary node synchronisation, it is possible to manually trigger synchronisation of a backup through:</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb100-1" data-line-number="1"><span class="ex">barman</span> sync-backup <span class="op">&lt;</span>server_name<span class="op">&gt;</span> <span class="op">&lt;</span>backup_id<span class="op">&gt;</span></a></code></pre></div>
<p>Launching <code>sync-backup</code> barman will use the primary_ssh_command to connect to the master server, then if the backup is present on the remote machine, will begin to copy all the files using rsync. Only one single synchronisation process per backup is allowed.</p>
<p>WAL files also can be synchronised, through:</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb101-1" data-line-number="1"><span class="ex">barman</span> sync-wals <span class="op">&lt;</span>server_name<span class="op">&gt;</span></a></code></pre></div>

<h1 id="barman-client-utilities-barman-cli">Barman client utilities (<code>barman-cli</code>)</h1>
<p>Formerly a separate open-source project, <code>barman-cli</code> has been merged into Barman's core since version 2.8, and is distributed as an RPM/Debian package. <code>barman-cli</code> contains a set of recommended client utilities to be installed alongside the PostgreSQL server:</p>
<ul>
<li><code>barman-wal-archive</code>: archiving script to be used as <code>archive_command</code> as described in the &quot;WAL archiving via <code>barman-wal-archive</code>&quot; section;</li>
<li><code>barman-wal-restore</code>: WAL restore script to be used as part of the <code>restore_command</code> recovery option on standby and recovery servers, as described in the &quot;<code>get-wal</code>&quot; section above;</li>
</ul>
<p>For more detailed information, please refer to the specific man pages or the <code>--help</code> option.</p>
<h2 id="installation-1">Installation</h2>
<p>Barman client utilities are normally installed where PostgreSQL is installed. Our recommendation is to install the <code>barman-cli</code> package on every PostgreSQL server, being that primary or standby.</p>
<p>Please refer to the main &quot;Installation&quot; section to install the repositories.</p>
<p>To install the package on RedHat/CentOS system, as <code>root</code> type:</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb102-1" data-line-number="1"><span class="ex">yum</span> install barman-cli</a></code></pre></div>
<p>On Debian/Ubuntu, as <code>root</code> user type:</p>
<div class="sourceCode" id="cb103"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb103-1" data-line-number="1"><span class="ex">apt-get</span> install barman-cli</a></code></pre></div>
<h1 id="barman-client-utilities-for-the-cloud-barman-cli-cloud">Barman client utilities for the Cloud (<code>barman-cli-cloud</code>)</h1>
<p>Barman client utilities have been extended to support object storage integration and enhance disaster recovery capabilities of your PostgreSQL databases by relaying WAL files and backups to a supported cloud provider.</p>
<p>Supported cloud providers are:</p>
<ul>
<li>AWS S3 (or any S3 compatible object store)</li>
<li>Azure Blob Storage</li>
<li>Google Cloud Storage (Rest API)</li>
</ul>
<p>These utilities are distributed in the <code>barman-cli-cloud</code> RPM/Debian package, and can be installed alongside the PostgreSQL server:</p>
<ul>
<li><code>barman-cloud-wal-archive</code>: archiving script to be used as <code>archive_command</code> to directly ship WAL files to cloud storage, bypassing the Barman server; alternatively, as a hook script for WAL archiving (<code>pre_archive_retry_script</code>);</li>
<li><code>barman-cloud-wal-restore</code>: script to be used as <code>restore_command</code> to fetch WAL files from cloud storage, bypassing the Barman server, and store them directly in the PostgreSQL standby;</li>
<li><code>barman-cloud-backup</code>: backup script to be used to take a local backup directly on the PostgreSQL server and to ship it to a supported cloud provider, bypassing the Barman server; alternatively, as a hook script for copying barman backups to the cloud (<code>post_backup_retry_script)</code></li>
<li><code>barman-cloud-backup-delete</code>: script to be used to delete one or more backups taken with <code>barman-cloud-backup</code> from cloud storage and remove associated WALs;</li>
<li><code>barman-cloud-backup-keep</code>: script to be used to flag backups in cloud storage as archival backups - such backups will be kept forever regardless of any retention policies applied;</li>
<li><code>barman-cloud-backup-list</code>: script to be used to list the content of Barman backups taken with <code>barman-cloud-backup</code> from cloud storage;</li>
<li><code>barman-cloud-restore</code>: script to be used to restore a backup directly taken with <code>barman-cloud-backup</code> from cloud storage;</li>
</ul>
<p>These commands require the appropriate library for the cloud provider you wish to use:</p>
<ul>
<li>AWS S3: <a href="https://github.com/boto/boto3">boto3</a></li>
<li>Azure Blob Storage: <a href="https://docs.microsoft.com/en-us/python/api/azure-storage-blob/?view=azure-python">azure-storage-blob</a> and (optionally) <a href="https://docs.microsoft.com/en-us/python/api/azure-identity/?view=azure-python">azure-identity</a></li>
<li>Google Cloud Storage: <a href="https://cloud.google.com/storage/docs/reference/libraries">google-cloud-storage</a></li>
</ul>
<p><strong>NOTE:</strong> The latest versions of these libraries do not support python 2 due to it being <a href="https://www.python.org/doc/sunset-python-2/">end-of-lfe</a> since Januaray 2020. If you are using the Barman cloud utilities on a python 2 system it is recommended you upgrade to python 3. If you still want to use the Barman cloud utilities with python 2 then you will need to ensure the following version requirements are met for each library:</p>
<ul>
<li><code>boto3&lt;1.18.0</code></li>
<li><code>azure-storage-blob&lt;12.10.0</code> and <code>azure-identity&lt;1.8.0</code></li>
<li><code>google-cloud-storage&lt;2.0.0</code></li>
</ul>
<p>For information on how to setup credentials for the aws-s3 cloud provider please refer to the <a href="https://boto3.amazonaws.com/v1/documentation/api/latest/guide/configuration.html">&quot;Credentials&quot; section in Boto 3 documentation</a>.</p>
<p>For credentials for the azure-blob-storage cloud provider see the <a href="https://docs.microsoft.com/en-us/azure/storage/blobs/authorize-data-operations-cli#set-environment-variables-for-authorization-parameters">&quot;Environment variables for authorization parameters&quot; section in the Azure documentation</a>. The following environment variables are supported: <code>AZURE_STORAGE_CONNECTION_STRING</code>, <code>AZURE_STORAGE_KEY</code> and <code>AZURE_STORAGE_SAS_TOKEN</code>. You can also use the <code>--credential</code> option to specify either <code>azure-cli</code> or <code>managed-identity</code> credentials in order to authenticate via Azure Active Directory.</p>
<h2 id="installation-2">Installation</h2>
<p>Barman client utilities for the Cloud need to be installed on those PostgreSQL servers that you want to direcly backup to a cloud provider, bypassing Barman.</p>
<p>In case you want to use <code>barman-cloud-backup</code> and/or <code>barman-cloud-wal-archive</code> as hook scripts, you can install the <code>barman-cli-cloud</code> package on the Barman server also.</p>
<p>Please refer to the main &quot;Installation&quot; section to install the repositories.</p>
<p>To install the package on RedHat/CentOS system, as <code>root</code> type:</p>
<div class="sourceCode" id="cb104"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb104-1" data-line-number="1"><span class="ex">yum</span> install barman-cli-cloud</a></code></pre></div>
<p>On Debian/Ubuntu, as <code>root</code> user type:</p>
<div class="sourceCode" id="cb105"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb105-1" data-line-number="1"><span class="ex">apt-get</span> install barman-cli-cloud</a></code></pre></div>
<h2 id="barman-cloud-hook-scripts">barman-cloud hook scripts</h2>
<p>Install the <code>barman-cli-cloud</code> package on the Barman server as described above.</p>
<p>Configure <code>barman-cloud-backup</code> as a post backup script by adding the following to the Barman configuration for a PostgreSQL server:</p>
<pre><code>post_backup_retry_script = &#39;barman-cloud-backup [*OPTIONS*] *DESTINATION_URL* ${BARMAN_SERVER}</code></pre>
<blockquote>
<p><strong>WARNING:</strong> When running as a hook script barman-cloud-backup requires that the status of the backup is DONE and it will fail if the backup has any other status. For this reason it is recommended backups are run with the <code>-w / --wait</code> option so that the hook script is not executed while a backup has status <code>WAITING_FOR_WALS</code>.</p>
</blockquote>
<p>Configure <code>barman-cloud-wal-archive</code> as a pre WAL archive script by adding the following to the Barman configuration for a PostgreSQL server:</p>
<pre><code>pre_archive_retry_script = &#39;barman-cloud-wal-archive [*OPTIONS*] *DESTINATION_URL* ${BARMAN_SERVER}&#39;</code></pre>
<h2 id="selecting-a-cloud-provider">Selecting a cloud provider</h2>
<p>Use the <code>--cloud-provider</code> option to choose the cloud provider for your backups and WALs. This can be set to one of the following:</p>
<ul>
<li><code>aws-s3</code> [DEFAULT]: AWS S3 or S3-compatible object store.</li>
<li><code>azure-blob-storage</code>: Azure Blob Storage service.</li>
<li><code>google-cloud-storage</code>: Google Cloud Storage service.</li>
</ul>
<h2 id="specificity-by-provider">Specificity by provider</h2>
<h3 id="google-cloud-storage">Google Cloud Storage</h3>
<h4 id="set-up">set up</h4>
<p>It will need google_storage_client dependency:</p>
<div class="sourceCode" id="cb108"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb108-1" data-line-number="1"><span class="ex">pip3</span> install google-cloud-storage </a></code></pre></div>
<p>To set credentials:</p>
<ul>
<li><p><a href="https://cloud.google.com/docs/authentication/getting-started#setting_the_environment_variable">Create a service account</a> And create a service account key.</p></li>
<li><p>Set bucket access rights:</p>
<p>We suggest to give <a href="https://cloud.google.com/storage/docs/access-control/iam-roles">Storage Admin Role</a> to the service account on the bucket.</p></li>
<li><p>When using barman_cloud, If the bucket does not exist, it will be created. Default options will be used to create the bucket. If you need the bucket to have specific options (region, storage class, labels), it is advised to create and set the bucket to match all you needs.</p></li>
<li><p>Set <a href="https://cloud.google.com/docs/authentication/getting-started#setting_the_environment_variable">env variable</a> <code>GOOGLE_APPLICATION_CREDENTIALS</code> to the service account key file path.</p>
<p>If running barman cloud from postgres (archive_command or restore_command), do not forget to set <code>GOOGLE_APPLICATION_CREDENTIALS</code> in postgres environment file.</p></li>
</ul>
<h4 id="usage">Usage</h4>
<p>Some details are specific to all barman cloud commands: * Select Google Cloud Storage<code>--cloud-provider=google-cloud-storage</code> * <code>SOURCE_URL</code> support both gs and https format. ex: <code>gs://BUCKET_NAME/path   or   https://console.cloud.google.com/storage/browser/BUCKET_NAME/path</code></p>

<h1 id="troubleshooting">Troubleshooting</h1>
<h2 id="diagnose-a-barman-installation">Diagnose a Barman installation</h2>
<p>You can gather important information about the status of all the configured servers using:</p>
<div class="sourceCode" id="cb109"><pre class="sourceCode bash"><code class="sourceCode bash"><a class="sourceLine" id="cb109-1" data-line-number="1"><span class="ex">barman</span> diagnose</a></code></pre></div>
<p>The <code>diagnose</code> command output is a full snapshot of the barman server, providing useful information, such as global configuration, SSH version, Python version, <code>rsync</code> version, PostgreSQL clients version, as well as current configuration and status of all servers.</p>
<p>The <code>diagnose</code> command is extremely useful for troubleshooting problems, as it gives a global view on the status of your Barman installation.</p>
<h2 id="requesting-help">Requesting help</h2>
<p>Although Barman is extensively documented, there are a lot of scenarios that are not covered.</p>
<p>For any questions about Barman and disaster recovery scenarios using Barman, you can reach the dev team using the community mailing list:</p>
<p>https://groups.google.com/group/pgbarman</p>
<p>or the IRC channel on freenode: irc://irc.freenode.net/barman</p>
<p>In the event you discover a bug, you can open a ticket using GitHub: https://github.com/EnterpriseDB/barman/issues</p>
<p>EnterpriseDB provides professional support for Barman, including 24/7 service.</p>
<h3 id="submitting-a-bug">Submitting a bug</h3>
<p>Barman has been extensively tested and is currently being used in several production environments. However, as any software, Barman is not bug free.</p>
<p>If you discover a bug, please follow this procedure:</p>
<ul>
<li>execute the <code>barman diagnose</code> command</li>
<li>file a bug through the GitHub issue tracker, by attaching the output obtained by the diagnostics command above (<code>barman diagnose</code>)</li>
</ul>
<blockquote>
<p><strong>WARNING:</strong> Be careful when submitting the output of the diagnose command as it might disclose information that are potentially dangerous from a security point of view.</p>
</blockquote>

<h1 id="the-barman-project">The Barman project</h1>
<h2 id="support-and-sponsor-opportunities">Support and sponsor opportunities</h2>
<p>Barman is free software, written and maintained by EnterpriseDB. If you require support on using Barman, or if you need new features, please get in touch with EnterpriseDB. You can sponsor the development of new features of Barman and PostgreSQL which will be made publicly available as open source.</p>
<p>For further information, please visit:</p>
<ul>
<li><a href="https://www.pgbarman.org/">Barman website</a></li>
<li><a href="https://www.pgbarman.org/support/">Support section</a></li>
<li><a href="https://www.enterprisedb.com/">EnterpriseDB website</a></li>
<li><a href="https://www.pgbarman.org/faq/">Barman FAQs</a></li>
<li><a href="https://blog.2ndquadrant.com/tag/barman/">2ndQuadrant blog: Barman</a></li>
</ul>
<h2 id="contributing-to-barman">Contributing to Barman</h2>
<p>EnterpriseDB has a team of software engineers, architects, database administrators, system administrators, QA engineers, developers and managers that dedicate their time and expertise to improve Barman's code. We adopt lean and agile methodologies for software development, and we believe in the <em>devops</em> culture that allowed us to implement rigorous testing procedures through cross-functional collaboration. Every Barman commit is the contribution of multiple individuals, at different stages of the production pipeline.</p>
<p>Even though this is our preferred way of developing Barman, we gladly accept patches from external developers, as long as:</p>
<ul>
<li>user documentation (tutorial and man pages) is provided.</li>
<li>source code is properly documented and contains relevant comments.</li>
<li>code supplied is covered by unit tests.</li>
<li>no unrelated feature is compromised or broken.</li>
<li>source code is rebased on the current master branch.</li>
<li>commits and pull requests are limited to a single feature (multi-feature patches are hard to test and review).</li>
<li>changes to the user interface are discussed beforehand with EnterpriseDB.</li>
</ul>
<p>We also require that any contributions provide a copyright assignment and a disclaimer of any work-for-hire ownership claims from the employer of the developer.</p>
<p>You can use GitHub's pull requests system for this purpose.</p>
<h2 id="authors">Authors</h2>
<p>In alphabetical order:</p>
<ul>
<li>Abhijit Menon-Sen</li>
<li>Didier Michel</li>
<li>Michael Wallace</li>
</ul>
<p>Past contributors (in alphabetical order):</p>
<ul>
<li>Anna Bellandi (QA/testing)</li>
<li>Britt Cole (documentation reviewer)</li>
<li>Carlo Ascani (developer)</li>
<li>Francesco Canovai (QA/testing)</li>
<li>Gabriele Bartolini (architect)</li>
<li>Gianni Ciolli (QA/testing)</li>
<li>Giulio Calacoci (developer)</li>
<li>Giuseppe Broccolo (developer)</li>
<li>Jane Threefoot (developer)</li>
<li>Jonathan Battiato (QA/testing)</li>
<li>Leonardo Cecchi (developer)</li>
<li>Marco Nenciarini (project leader)</li>
<li>Niccol Fei (QA/testing)</li>
<li>Rubens Souza (QA/testing)</li>
<li>Stefano Bianucci (developer)</li>
</ul>
<h2 id="links">Links</h2>
<ul>
<li><a href="https://github.com/hamann/check-barman">check-barman</a>: a Nagios plugin for Barman, written by Holger Hamann (MIT license)</li>
<li><a href="https://github.com/2ndquadrant-it/puppet-barman">puppet-barman</a>: Barman module for Puppet (GPL)</li>
<li><a href="https://goo.gl/218Ghl">Tutorial on &quot;How To Back Up, Restore, and Migrate PostgreSQL Databases with Barman on CentOS 7&quot;</a>, by Sadequl Hussain (available on DigitalOcean Community)</li>
<li><a href="https://github.com/emin100/barmanapi">BarmanAPI</a>: RESTFul API for Barman, written by Mehmet Emin Karaka (GPL)</li>
</ul>
<h2 id="license-and-contributions">License and Contributions</h2>
<p>Barman is the property of EnterpriseDB UK Limited and its code is distributed under GNU General Public License 3.</p>
<p> Copyright EnterpriseDB UK Limited 2011-2022</p>
<p>Barman has been partially funded through <a href="https://4caast.morfeo-project.org/">4CaaSt</a>, a research project funded by the European Commission's Seventh Framework programme.</p>
<p>Contributions to Barman are welcome, and will be listed in the <code>AUTHORS</code> file. EnterpriseDB UK Limited requires that any contributions provide a copyright assignment and a disclaimer of any work-for-hire ownership claims from the employer of the developer. This lets us make sure that all of the Barman distribution remains free code. Please contact barman@enterprisedb.com for a copy of the relevant Copyright Assignment Form.</p>
<!-- Reference links -->
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>It is important that you know the difference between logical and physical backup, therefore between <code>pg_dump</code> and a tool like Barman.<a href="#fnref1" class="footnote-back"></a></p></li>
<li id="fn2"><p>Integration with Nagios/Icinga is straightforward thanks to the <code>barman check --nagios</code> command, one of the most important features of Barman and a true lifesaver.<a href="#fnref2" class="footnote-back"></a></p></li>
<li id="fn3"><p>The same <a href="https://www.postgresql.org/docs/current/static/warm-standby.html#STANDBY-PLANNING">requirements for PostgreSQL's PITR</a> apply for recovery, as detailed in the section <em>&quot;Requirements for recovery&quot;</em>.<a href="#fnref3" class="footnote-back"></a></p></li>
<li id="fn4"><p>Backup of a PostgreSQL server on Windows is possible, but it is still experimental because it is not yet part of our continuous integration system. See section <em>&quot;How to setup a Windows based server&quot;</em> for details.<a href="#fnref4" class="footnote-back"></a></p></li>
<li id="fn5"><p>Replication slots have been introduced in PostgreSQL 9.4. See section <em>&quot;WAL Streaming / Replication slots&quot;</em> for details.<a href="#fnref5" class="footnote-back"></a></p></li>
<li id="fn6"><p>Concurrent backup is a technology that uses the <em>streaming replication protocol</em> (for example, using a tool like <code>pg_basebackup</code>).<a href="#fnref6" class="footnote-back"></a></p></li>
</ol>
</section>
            </div>
    </div>
  </div>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  
</body>
</html>
